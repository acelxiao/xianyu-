{% extends "base.html" %}

{% block title %}ç³»ç»Ÿè®¾ç½® - é—²é±¼æ•°æ®ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<!-- ç³»ç»ŸçŠ¶æ€æ¦‚è§ˆ -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div id="spiderStatus" class="mb-2">
                    <i class="bi bi-robot display-4 text-warning"></i>
                </div>
                <h6 class="card-title">çˆ¬è™«çŠ¶æ€</h6>
                <span class="badge bg-secondary" id="spiderStatusText">æ£€æµ‹ä¸­...</span>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div id="serverStatus" class="mb-2">
                    <i class="bi bi-server display-4 text-warning"></i>
                </div>
                <h6 class="card-title">æœåŠ¡å™¨çŠ¶æ€</h6>
                <span class="badge bg-secondary" id="serverStatusText">æ£€æµ‹ä¸­...</span>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div id="cookieStatus" class="mb-2">
                    <i class="bi bi-cookie display-4 text-warning"></i>
                </div>
                <h6 class="card-title">CookieçŠ¶æ€</h6>
                <span class="badge bg-secondary" id="cookieStatusText">æ£€æµ‹ä¸­...</span>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="mb-2">
                    <i class="bi bi-database display-4 text-info"></i>
                </div>
                <h6 class="card-title">æ•°æ®åº“</h6>
                <span class="badge bg-info" id="dbCount">-</span>
            </div>
        </div>
    </div>
</div>

<!-- Cookieç®¡ç† -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-shield-lock me-2"></i> Cookie ç®¡ç†
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="cookieInput" class="form-label">
                        <i class="bi bi-key me-1"></i> Cookie å­—ç¬¦ä¸²
                    </label>
                    <textarea class="form-control" id="cookieInput" rows="6"
                              placeholder="è¯·ç²˜è´´ä»é—²é±¼ç½‘ç«™è·å–çš„å®Œæ•´Cookieå­—ç¬¦ä¸²ï¼Œæ ¼å¼å¦‚ï¼šname1=value1; name2=value2; ...">{{ current_cookie or '' }}</textarea>
                    <div class="form-text">
                        <i class="bi bi-info-circle me-1"></i>
                        ä»æµè§ˆå™¨å¼€å‘è€…å·¥å…·ä¸­è·å–å®Œæ•´çš„Cookieå­—ç¬¦ä¸²
                        <span class="float-end" id="cookieLength">å­—ç¬¦æ•°: 0</span>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="d-grid gap-2 d-md-block">
                            <button class="btn btn-primary" onclick="updateCookie()">
                                <i class="bi bi-check-circle me-1"></i> æ›´æ–°Cookie
                            </button>
                            <button class="btn btn-outline-info" onclick="testCookie()">
                                <i class="bi bi-play-circle me-1"></i> æµ‹è¯•Cookie
                            </button>
                            <button class="btn btn-outline-secondary" onclick="formatCookie()">
                                <i class="bi bi-arrow-clockwise me-1"></i> æ ¼å¼åŒ–
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-grid gap-2 d-md-block text-md-end">
                            <button class="btn btn-outline-warning" onclick="showCookieGuide()">
                                <i class="bi bi-question-circle me-1"></i> è·å–æŒ‡å—
                            </button>
                            <button class="btn btn-outline-success" onclick="backupCookie()">
                                <i class="bi bi-download me-1"></i> å¤‡ä»½Cookie
                            </button>
                        </div>
                    </div>
                </div>

                <!-- CookieçŠ¶æ€æ˜¾ç¤º -->
                <div id="cookieStatus" class="mt-3"></div>

                <!-- Cookieè¯¦ç»†ä¿¡æ¯ -->
                <div id="cookieInfo" class="alert alert-info mt-3" style="display: none;">
                    <h6 class="alert-heading">
                        <i class="bi bi-info-circle me-2"></i> Cookie è¯¦ç»†ä¿¡æ¯
                    </h6>
                    <div id="cookieDetails"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ç®¡ç†å‘˜ä¸“ç”¨ - ä½“éªŒè´¦æˆ·ç®¡ç† -->
<!-- è°ƒè¯•ä¿¡æ¯: session.role = {{ session.role if session.role else 'None' }} -->
{% if session.role == 'admin' %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">
                    <i class="bi bi-shield-lock me-2"></i> ä½“éªŒè´¦æˆ·ç®¡ç†
                    <span class="badge bg-warning text-dark ms-2">ç®¡ç†å‘˜ä¸“ç”¨</span>
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <form id="extendTrialForm" class="d-flex align-items-end">
                            <div class="me-2 flex-grow-1">
                                <label for="trialUsername" class="form-label">
                                    <i class="bi bi-person me-1"></i> ä½“éªŒè´¦æˆ·ç”¨æˆ·å
                                </label>
                                <input type="text" class="form-control" id="trialUsername"
                                       placeholder="è¾“å…¥è¦å»¶æœŸçš„ä½“éªŒè´¦æˆ·ç”¨æˆ·å" required>
                                <div class="form-text">
                                    è¾“å…¥éœ€è¦å»¶é•¿æ—¶é—´çš„ä½“éªŒè´¦æˆ·ç”¨æˆ·åï¼Œå¦‚: trial
                                </div>
                            </div>
                            <div class="me-2">
                                <label for="extendMinutes" class="form-label">
                                    <i class="bi bi-clock me-1"></i> å»¶é•¿æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
                                </label>
                                <input type="number" class="form-control" id="extendMinutes"
                                       value="2" min="1" max="1440" style="width: 120px;">
                                <div class="form-text">é»˜è®¤2åˆ†é’Ÿ</div>
                            </div>
                            <div>
                                <button type="button" class="btn btn-success" onclick="extendTrial()">
                                    <i class="bi bi-arrow-clockwise me-1"></i> å»¶æœŸä½“éªŒ
                                </button>
                            </div>
                        </form>

                        <div id="extendTrialStatus" class="mt-3"></div>
                    </div>
                    <div class="col-md-4">
                        <div class="alert alert-info mb-0">
                            <h6 class="alert-heading">
                                <i class="bi bi-info-circle me-2"></i> ç®¡ç†è¯´æ˜
                            </h6>
                            <ul class="mb-0 small">
                                <li>åªæœ‰ç®¡ç†å‘˜å¯ä»¥å»¶é•¿ä½“éªŒè´¦æˆ·æ—¶é—´</li>
                                <li>ä½“éªŒè´¦æˆ·è¿‡æœŸåæ— æ³•ç™»å½•</li>
                                <li>å»¶æœŸæ—¶é—´ä»å½“å‰æ—¶é—´å¼€å§‹è®¡ç®—</li>
                                <li>å»ºè®®æ¯æ¬¡å»¶é•¿2-10åˆ†é’Ÿè¿›è¡Œæµ‹è¯•</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- å½“å‰ä½“éªŒè´¦æˆ·çŠ¶æ€ -->
                <div class="mt-3">
                    <h6><i class="bi bi-list-ul me-2"></i>å½“å‰ä½“éªŒè´¦æˆ·çŠ¶æ€</h6>
                    <div id="trialUsersStatus" class="table-responsive">
                        <table class="table table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>ç”¨æˆ·å</th>
                                    <th>è§’è‰²</th>
                                    <th>å‰©ä½™æ—¶é—´</th>
                                    <th>çŠ¶æ€</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="trialUsersList">
                                <tr>
                                    <td colspan="5" class="text-center text-muted">
                                        <i class="bi bi-hourglass-split me-2"></i>æ­£åœ¨åŠ è½½ä½“éªŒè´¦æˆ·ä¿¡æ¯...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- çˆ¬è™«ç»Ÿè®¡ -->
<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="card border-0 bg-primary text-white h-100">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h3 class="mb-1" id="totalScraped">-</h3>
                        <p class="mb-0 opacity-75">æ€»çˆ¬å–æ•°</p>
                    </div>
                    <div class="ms-3">
                        <i class="bi bi-database display-4 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card border-0 bg-success text-white h-100">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h3 class="mb-1" id="todayScraped">-</h3>
                        <p class="mb-0 opacity-75">ä»Šæ—¥çˆ¬å–</p>
                    </div>
                    <div class="ms-3">
                        <i class="bi bi-calendar-day display-4 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card border-0 bg-info text-white h-100">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h3 class="mb-1" id="successRate">-</h3>
                        <p class="mb-0 opacity-75">æˆåŠŸç‡</p>
                    </div>
                    <div class="ms-3">
                        <i class="bi bi-check-circle display-4 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-12">
        <div class="card border-0 bg-light">
            <div class="card-body py-2">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-clock-history text-muted me-2"></i>
                        <small class="text-muted">æœ€åçˆ¬å–æ—¶é—´: <span id="lastScrape" class="fw-bold text-dark">-</span></small>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="d-flex align-items-center me-3" id="spiderStatusIndicator">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-check-circle text-success me-2"></i>
                                <small class="text-success">çˆ¬è™«ç©ºé—²</small>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshScrapingStats()">
                            <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- é€šçŸ¥é…ç½®ç®¡ç† -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="bi bi-bell"></i> é€šçŸ¥é…ç½®ç®¡ç†
                    <span class="badge bg-primary ms-2" id="configCount">0</span>
                </h6>
                <div>
                    <button class="btn btn-primary btn-sm" onclick="showAddNotificationModal()">
                        <i class="bi bi-plus-circle me-1"></i> æ·»åŠ é€šçŸ¥é…ç½®
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- é€šçŸ¥é…ç½®åˆ—è¡¨ -->
                <div id="notificationConfigsList">
                    <div class="text-center text-muted">
                        <i class="bi bi-hourglass-split me-2"></i>æ­£åœ¨åŠ è½½é€šçŸ¥é…ç½®...
                    </div>
                </div>

                <!-- ç«‹å³æ‰§è¡Œçš„é€šçŸ¥é…ç½®åŠ è½½è„šæœ¬ -->
                <script>
                    // ç«‹å³å¼ºåˆ¶åŠ è½½é€šçŸ¥é…ç½®
                    console.log('ğŸš€ å†…è”è„šæœ¬ï¼šå¼€å§‹å¼ºåˆ¶åŠ è½½é€šçŸ¥é…ç½®');

                    // ç›´æ¥æ‰§è¡ŒåŠ è½½ï¼Œä¸ä¾èµ–ä»»ä½•å¤–éƒ¨å‡½æ•°
                    const container = document.getElementById('notificationConfigsList');
                    if (container) {
                        console.log('âœ… æ‰¾åˆ°å®¹å™¨ï¼Œå¼€å§‹åŠ è½½...');
                        container.innerHTML = '<div class="text-center text-info py-3"><i class="bi bi-arrow-clockwise spin"></i> æ­£åœ¨åŠ è½½...</div>';

                        // ç«‹å³å‘èµ·APIè¯·æ±‚
                        fetch('/api/notification-configs?t=' + Date.now())
                            .then(response => response.json())
                            .then(result => {
                                console.log('ğŸ“¦ APIå“åº”:', result);
                                if (result.success && result.configs.length > 0) {
                                    container.innerHTML = '<div class="alert alert-success m-3"><i class="bi bi-check-circle me-2"></i>å·²æˆåŠŸåŠ è½½ ' + result.configs.length + ' ä¸ªé€šçŸ¥é…ç½®</div>';
                                    console.log('âœ… é€šçŸ¥é…ç½®åŠ è½½æˆåŠŸ!');
                                } else {
                                    container.innerHTML = '<div class="alert alert-warning m-3"><i class="bi bi-exclamation-triangle me-2"></i>æš‚æ— é€šçŸ¥é…ç½®</div>';
                                    console.log('âš ï¸ æš‚æ— é€šçŸ¥é…ç½®');
                                }
                            })
                            .catch(error => {
                                console.error('âŒ åŠ è½½å¤±è´¥:', error);
                                container.innerHTML = '<div class="alert alert-danger m-3"><i class="bi bi-x-circle me-2"></i>åŠ è½½å¤±è´¥: ' + error.message + '</div>';
                            });
                    } else {
                        console.error('âŒ æ‰¾ä¸åˆ°å®¹å™¨å…ƒç´ ');
                    }

                    // å†æ¬¡å°è¯•è°ƒç”¨å¤–éƒ¨å‡½æ•°ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    setTimeout(() => {
                        if (typeof loadNotificationConfigs === 'function') {
                            console.log('ğŸ”„ è°ƒç”¨å¤–éƒ¨loadNotificationConfigså‡½æ•°');
                            loadNotificationConfigs();
                        }
                    }, 1000);
                </script>
            </div>
        </div>
    </div>
</div>

<!-- é€šçŸ¥é…ç½®æ¨¡æ€æ¡† -->
<div class="modal fade" id="notificationConfigModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-bell me-2"></i>
                    <span id="notificationModalTitle">æ·»åŠ é€šçŸ¥é…ç½®</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="notificationConfigForm">
                    <input type="hidden" id="notificationConfigId">

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="notificationPlatform" class="form-label">é€šçŸ¥å¹³å°</label>
                                <select class="form-select" id="notificationPlatform" required onchange="updateNotificationFields()">
                                    <option value="">è¯·é€‰æ‹©é€šçŸ¥å¹³å°</option>
                                    <option value="dingtalk">é’‰é’‰</option>
                                    <option value="feishu">é£ä¹¦</option>
                                    <option value="wechat_work">ä¼ä¸šå¾®ä¿¡</option>
                                    <option value="email">é‚®ä»¶</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="notificationName" class="form-label">é…ç½®åç§°</label>
                                <input type="text" class="form-control" id="notificationName" required
                                       placeholder="ä¾‹å¦‚ï¼šå·¥ä½œç¾¤é€šçŸ¥">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="notificationDescription" class="form-label">æè¿°</label>
                        <input type="text" class="form-control" id="notificationDescription"
                               placeholder="é…ç½®æè¿°ï¼ˆå¯é€‰ï¼‰">
                    </div>

                    <!-- é’‰é’‰é…ç½® -->
                    <div id="dingtalkConfig" class="notification-platform-config" style="display: none;">
                        <div class="mb-3">
                            <label for="dingtalkWebhook" class="form-label">é’‰é’‰ Webhook URL</label>
                            <input type="url" class="form-control" id="dingtalkWebhook"
                                   placeholder="https://oapi.dingtalk.com/robot/send?access_token=...">
                            <div class="form-text">ä»é’‰é’‰ç¾¤æœºå™¨äººè®¾ç½®ä¸­è·å–</div>
                        </div>
                        <div class="mb-3">
                            <label for="dingtalkSecret" class="form-label">é’‰é’‰ç­¾åå¯†é’¥ï¼ˆå¯é€‰ï¼‰</label>
                            <input type="text" class="form-control" id="dingtalkSecret"
                                   placeholder="SECå¼€å¤´çš„å¯†é’¥">
                            <div class="form-text">ç”¨äºå®‰å…¨éªŒè¯ï¼Œå¯é€‰</div>
                        </div>
                    </div>

                    <!-- é£ä¹¦é…ç½® -->
                    <div id="feishuConfig" class="notification-platform-config" style="display: none;">
                        <div class="mb-3">
                            <label for="feishuWebhook" class="form-label">é£ä¹¦ Webhook URL</label>
                            <input type="url" class="form-control" id="feishuWebhook"
                                   placeholder="https://open.feishu.cn/open-apis/bot/v2/hook/...">
                            <div class="form-text">ä»é£ä¹¦ç¾¤æœºå™¨äººè®¾ç½®ä¸­è·å–</div>
                        </div>
                    </div>

                    <!-- ä¼ä¸šå¾®ä¿¡é…ç½® -->
                    <div id="wechatWorkConfig" class="notification-platform-config" style="display: none;">
                        <div class="mb-3">
                            <label for="wechatWorkWebhook" class="form-label">ä¼ä¸šå¾®ä¿¡ Webhook URL</label>
                            <input type="url" class="form-control" id="wechatWorkWebhook"
                                   placeholder="https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=...">
                            <div class="form-text">ä»ä¼ä¸šå¾®ä¿¡ç¾¤æœºå™¨äººè®¾ç½®ä¸­è·å–</div>
                        </div>
                    </div>

                    <!-- é‚®ä»¶é…ç½® -->
                    <div id="emailConfig" class="notification-platform-config" style="display: none;">
                        <div class="mb-3">
                            <label for="emailAddress" class="form-label">é‚®ç®±åœ°å€</label>
                            <input type="email" class="form-control" id="emailAddress" required>
                        </div>
                        <div class="mb-3">
                            <label for="emailSmtp" class="form-label">SMTP æœåŠ¡å™¨</label>
                            <input type="text" class="form-control" id="emailSmtp" placeholder="smtp.gmail.com">
                            <div class="form-text">ä¾‹å¦‚ï¼šsmtp.gmail.com (Gmail), smtp.163.com (ç½‘æ˜“é‚®ç®±)</div>
                        </div>
                        <div class="mb-3">
                            <label for="emailPassword" class="form-label">é‚®ç®±å¯†ç /æˆæƒç </label>
                            <input type="password" class="form-control" id="emailPassword" required>
                            <div class="form-text">å¯¹äºGmailç­‰éœ€è¦ä½¿ç”¨åº”ç”¨ä¸“ç”¨å¯†ç </div>
                        </div>
                    </div>

                    <!-- è§¦å‘äº‹ä»¶é…ç½® -->
                    <div class="mb-3">
                        <label class="form-label">è§¦å‘äº‹ä»¶</label>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="eventLatestProduct">
                                    <label class="form-check-label" for="eventLatestProduct">
                                        <i class="bi bi-clock-history me-2"></i>æœ€æ–°å‘å¸ƒå•†å“æ¨é€
                                        <small class="text-muted d-block">çˆ¬è™«å‘ç°å‘å¸ƒæ—¶é—´è¶Šæ–°çš„å•†å“ï¼Œä¼˜å…ˆæ¨é€é€šçŸ¥</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="notificationEnabled">
                            <label class="form-check-label" for="notificationEnabled">
                                å¯ç”¨æ­¤é€šçŸ¥é…ç½®
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="saveNotificationConfig()">ä¿å­˜é…ç½®</button>
            </div>
        </div>
    </div>
</div>

<!-- æ—¥å¿—ç›‘æ§ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="bi bi-terminal"></i> ç³»ç»Ÿæ—¥å¿—
                </h6>
                <div>
                    <select class="form-select form-select-sm d-inline-block w-auto me-2" id="logLevel" onchange="filterLogs()">
                        <option value="all">æ‰€æœ‰çº§åˆ«</option>
                        <option value="error">é”™è¯¯</option>
                        <option value="warning">è­¦å‘Š</option>
                        <option value="info">ä¿¡æ¯</option>
                        <option value="debug">è°ƒè¯•</option>
                    </select>
                    <button class="btn btn-outline-primary btn-sm" onclick="refreshLogs()">
                        <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°
                    </button>
                    <button class="btn btn-outline-warning btn-sm" onclick="clearLogs()">
                        <i class="bi bi-trash"></i> æ¸…ç©º
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="d-flex justify-content-between align-items-center px-3 py-2 border-bottom bg-light">
                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        æ˜¾ç¤ºæœ€è¿‘ <span id="logCount">0</span> æ¡æ—¥å¿—ï¼Œè‡ªåŠ¨åˆ·æ–°å·²å¼€å¯
                    </small>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                        <label class="form-check-label" for="autoRefresh">è‡ªåŠ¨åˆ·æ–°</label>
                    </div>
                </div>
                <div id="logContainer" style="height: 400px; overflow-y: auto; background-color: #1e1e1e; color: #ffffff; padding: 15px; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 13px; line-height: 1.4;">
                    <div class="text-muted text-center py-5" id="logLoadingPlaceholder">
                        <i class="bi bi-hourglass-split me-2"></i>æ­£åœ¨åŠ è½½ç³»ç»Ÿæ—¥å¿—...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ç³»ç»Ÿæ—¥å¿—ç«‹å³åŠ è½½è„šæœ¬ - å¢å¼ºç‰ˆ -->
<script>
(function() {
    'use strict';
    console.log('ğŸš€ ç³»ç»Ÿæ—¥å¿—å¢å¼ºå†…è”è„šæœ¬å¼€å§‹æ‰§è¡Œ...');

    // å…¨å±€çŠ¶æ€ç®¡ç†
    const loadState = {
        attempts: 0,
        maxAttempts: 60, // æœ€å¤šé‡è¯•60æ¬¡ï¼Œæ¯æ¬¡é—´éš”100msï¼Œæ€»è®¡6ç§’
        isLoaded: false,
        isLoading: false
    };

    // æ£€æŸ¥æ‰€æœ‰å¿…è¦çš„æ¡ä»¶æ˜¯å¦æ»¡è¶³
    function checkLoadConditions() {
        const conditions = {
            hasGenerateSystemLogs: typeof generateSystemLogs === 'function',
            hasDisplayLogs: typeof displayLogs === 'function',
            hasUpdateLogCount: typeof updateLogCount === 'function',
            hasLogContainer: !!document.getElementById('logContainer'),
            hasSystemLogs: typeof systemLogs !== 'undefined'
        };

        const allReady = Object.values(conditions).every(Boolean);

        if (loadState.attempts % 10 === 0) { // æ¯10æ¬¡æ£€æŸ¥æ‰“å°ä¸€æ¬¡çŠ¶æ€
            console.log(`ğŸ“Š åŠ è½½æ¡ä»¶æ£€æŸ¥ (${loadState.attempts}/${loadState.maxAttempts}):`, conditions);
        }

        return { allReady, conditions };
    }

    // æ‰§è¡Œç³»ç»Ÿæ—¥å¿—åŠ è½½
    function executeSystemLogsLoad() {
        if (loadState.isLoaded || loadState.isLoading) {
            console.log('â¸ï¸ ç³»ç»Ÿæ—¥å¿—å·²åŠ è½½æˆ–æ­£åœ¨åŠ è½½ï¼Œè·³è¿‡é‡å¤åŠ è½½');
            return true;
        }

        loadState.isLoading = true;
        console.log('ğŸ”„ å¼€å§‹æ‰§è¡Œç³»ç»Ÿæ—¥å¿—åŠ è½½...');

        try {
            // ç¡®ä¿å…¨å±€å˜é‡å­˜åœ¨
            if (typeof systemLogs === 'undefined') {
                window.systemLogs = [];
            }

            // ç”Ÿæˆç³»ç»Ÿæ—¥å¿—
            console.log('ğŸ“ ç”Ÿæˆç³»ç»Ÿæ—¥å¿—...');
            systemLogs = generateSystemLogs();
            console.log(`âœ… ç”Ÿæˆäº† ${systemLogs.length} æ¡æ—¥å¿—`);

            // æ˜¾ç¤ºæ—¥å¿—
            console.log('ğŸ“‹ æ˜¾ç¤ºæ—¥å¿—...');
            displayLogs();
            console.log('âœ… æ—¥å¿—æ˜¾ç¤ºå®Œæˆ');

            // æ›´æ–°è®¡æ•°
            console.log('ğŸ”¢ æ›´æ–°æ—¥å¿—è®¡æ•°...');
            updateLogCount();
            console.log('âœ… æ—¥å¿—è®¡æ•°æ›´æ–°å®Œæˆ');

            loadState.isLoaded = true;
            loadState.isLoading = false;
            console.log('ğŸ‰ ç³»ç»Ÿæ—¥å¿—åŠ è½½æˆåŠŸï¼');

            return true;
        } catch (error) {
            loadState.isLoading = false;
            console.error('âŒ æ‰§è¡Œç³»ç»Ÿæ—¥å¿—åŠ è½½æ—¶å‘ç”Ÿé”™è¯¯:', error);
            return false;
        }
    }

    // ä¸»è¦åŠ è½½å‡½æ•°
    function loadSystemLogsEnhanced() {
        loadState.attempts++;

        if (loadState.attempts > loadState.maxAttempts) {
            console.error(`âŒ è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•° (${loadState.maxAttempts})ï¼Œåœæ­¢åŠ è½½`);
            return;
        }

        const { allReady, conditions } = checkLoadConditions();

        if (allReady) {
            console.log(`âœ… æ‰€æœ‰æ¡ä»¶å·²æ»¡è¶³ (${loadState.attempts}/${loadState.maxAttempts})ï¼Œå¼€å§‹åŠ è½½...`);
            const success = executeSystemLogsLoad();
            if (success) {
                console.log('ğŸ¯ ç³»ç»Ÿæ—¥å¿—åŠ è½½ä»»åŠ¡å®Œæˆ');
                return;
            }
        }

        // å¦‚æœæ¡ä»¶ä¸æ»¡è¶³æˆ–åŠ è½½å¤±è´¥ï¼Œç»§ç»­é‡è¯•
        setTimeout(() => {
            loadSystemLogsEnhanced();
        }, 100);
    }

    // å¼ºåˆ¶åŠ è½½å‡½æ•°ï¼ˆå¿½ç•¥æ¡ä»¶æ£€æŸ¥ï¼‰
    function forceLoadSystemLogs() {
        console.log('ğŸš¨ å¼ºåˆ¶åŠ è½½ç³»ç»Ÿæ—¥å¿—ï¼ˆå¿½ç•¥æ¡ä»¶æ£€æŸ¥ï¼‰...');

        try {
            // å¼ºåˆ¶åˆå§‹åŒ–å…¨å±€å˜é‡
            if (typeof generateSystemLogs === 'function') {
                window.systemLogs = generateSystemLogs();
            } else {
                window.systemLogs = [{
                    timestamp: new Date().toLocaleString(),
                    level: 'warning',
                    message: 'ç³»ç»Ÿæ—¥å¿—åŠŸèƒ½å¯èƒ½å­˜åœ¨é—®é¢˜'
                }];
            }

            if (typeof displayLogs === 'function') {
                displayLogs();
            }

            if (typeof updateLogCount === 'function') {
                updateLogCount();
            }

            console.log('âœ… å¼ºåˆ¶åŠ è½½å®Œæˆ');
        } catch (error) {
            console.error('âŒ å¼ºåˆ¶åŠ è½½å¤±è´¥:', error);
        }
    }

    // å¯åŠ¨åŠ è½½
    console.log('ğŸ¯ å¯åŠ¨ç³»ç»Ÿæ—¥å¿—å¢å¼ºåŠ è½½...');
    loadSystemLogsEnhanced();

    // å¤šæ—¶é—´ç‚¹ä¿éšœæœºåˆ¶
    const fallbackTimes = [500, 1000, 2000, 3000, 5000]; // ms

    fallbackTimes.forEach((delay, index) => {
        setTimeout(() => {
            if (!loadState.isLoaded) {
                console.log(`ğŸ”„ ä¿éšœæœºåˆ¶ ${index + 1}/${fallbackTimes.length} (${delay}ms): å°è¯•åŠ è½½ç³»ç»Ÿæ—¥å¿—`);

                if (delay >= 3000) {
                    // 3ç§’åä½¿ç”¨å¼ºåˆ¶åŠ è½½
                    forceLoadSystemLogs();
                } else {
                    loadSystemLogsEnhanced();
                }
            } else {
                console.log(`âœ… ä¿éšœæœºåˆ¶ ${index + 1}/${fallbackTimes.length}: ç³»ç»Ÿæ—¥å¿—å·²åŠ è½½ï¼Œè·³è¿‡`);
            }
        }, delay);
    });

    // æœ€ç»ˆæ£€æŸ¥ï¼ˆ8ç§’åï¼‰
    setTimeout(() => {
        if (loadState.isLoaded) {
            console.log('ğŸ‰ ç³»ç»Ÿæ—¥å¿—åŠ è½½ä»»åŠ¡æœ€ç»ˆæˆåŠŸå®Œæˆ');
        } else {
            console.error('âŒ ç³»ç»Ÿæ—¥å¿—åŠ è½½æœ€ç»ˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥é¡µé¢JavaScriptæ˜¯å¦æœ‰é”™è¯¯');
            // æœ€åä¸€æ¬¡å¼ºåˆ¶åŠ è½½å°è¯•
            forceLoadSystemLogs();
        }
    }, 8000);

})();
</script>

<!-- äº§å“åŒ¹é…è§„åˆ™æ¨¡æ€æ¡† -->
<div class="modal fade" id="matchRuleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-funnel me-2"></i>
                    <span id="matchRuleModalTitle">æ·»åŠ åŒ¹é…è§„åˆ™</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="matchRuleForm">
                    <input type="hidden" id="matchRuleId" value="">

                    <!-- åŸºæœ¬ä¿¡æ¯ -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="ruleName" class="form-label">è§„åˆ™åç§° <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="ruleName" required>
                        </div>
                        <div class="col-md-6">
                            <label for="matchLogic" class="form-label">åŒ¹é…é€»è¾‘</label>
                            <select class="form-select" id="matchLogic">
                                <option value="AND">ANDï¼ˆå…¨éƒ¨æ¡ä»¶éƒ½åŒ¹é…ï¼‰</option>
                                <option value="OR">ORï¼ˆä»»ä¸€æ¡ä»¶åŒ¹é…ï¼‰</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="ruleDescription" class="form-label">è§„åˆ™æè¿°</label>
                        <textarea class="form-control" id="ruleDescription" rows="2" placeholder="æè¿°æ­¤è§„åˆ™çš„ç”¨é€”..."></textarea>
                    </div>

                    <!-- å…³é”®è¯åŒ¹é… -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-key me-2"></i>å…³é”®è¯åŒ¹é…</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="keywordsInclude" class="form-label">åŒ…å«å…³é”®è¯</label>
                                <input type="text" class="form-control" id="keywordsInclude"
                                       placeholder="å¤šä¸ªå…³é”®è¯ç”¨é€—å·åˆ†éš”ï¼Œå¦‚ï¼šæ‰‹æœº,è‹¹æœ,iPhone">
                                <div class="form-text">äº§å“æ ‡é¢˜å¿…é¡»åŒ…å«è¿™äº›å…³é”®è¯ä¸­çš„è‡³å°‘ä¸€ä¸ª</div>
                            </div>
                            <div class="mb-3">
                                <label for="keywordsExclude" class="form-label">æ’é™¤å…³é”®è¯</label>
                                <input type="text" class="form-control" id="keywordsExclude"
                                       placeholder="å¤šä¸ªå…³é”®è¯ç”¨é€—å·åˆ†éš”ï¼Œå¦‚ï¼šé›¶ä»¶,ç»´ä¿®,äºŒæ‰‹">
                                <div class="form-text">äº§å“æ ‡é¢˜ä¸èƒ½åŒ…å«è¿™äº›å…³é”®è¯</div>
                            </div>
                        </div>
                    </div>

                    <!-- ä»·æ ¼åŒ¹é… -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-currency-yen me-2"></i>ä»·æ ¼åŒ¹é…</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="priceMin" class="form-label">æœ€ä½ä»·æ ¼ï¼ˆå…ƒï¼‰</label>
                                    <input type="number" class="form-control" id="priceMin" min="0" step="0.01">
                                </div>
                                <div class="col-md-6">
                                    <label for="priceMax" class="form-label">æœ€é«˜ä»·æ ¼ï¼ˆå…ƒï¼‰</label>
                                    <input type="number" class="form-control" id="priceMax" min="0" step="0.01">
                                </div>
                            </div>
                            <div class="form-text">ç•™ç©ºè¡¨ç¤ºä¸é™ä»·æ ¼</div>
                        </div>
                    </div>

                    <!-- åœ°åŒºåŒ¹é… -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-geo-alt me-2"></i>åœ°åŒºåŒ¹é…</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="locationsInclude" class="form-label">åŒ…å«åœ°åŒº</label>
                                <input type="text" class="form-control" id="locationsInclude"
                                       placeholder="å¤šä¸ªåœ°åŒºç”¨é€—å·åˆ†éš”ï¼Œå¦‚ï¼šåŒ—äº¬,ä¸Šæµ·,å¹¿å·">
                                <div class="form-text">åªåŒ¹é…è¿™äº›åœ°åŒºçš„å•†å“</div>
                            </div>
                            <div class="mb-3">
                                <label for="locationsExclude" class="form-label">æ’é™¤åœ°åŒº</label>
                                <input type="text" class="form-control" id="locationsExclude"
                                       placeholder="å¤šä¸ªåœ°åŒºç”¨é€—å·åˆ†éš”ï¼Œå¦‚ï¼šè¥¿è—,æ–°ç–†">
                                <div class="form-text">ä¸åŒ¹é…è¿™äº›åœ°åŒºçš„å•†å“</div>
                            </div>
                        </div>
                    </div>

                    <!-- å–å®¶ä¿¡ç”¨ -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-shield-check me-2"></i>å–å®¶ä¿¡ç”¨</h6>
                        </div>
                        <div class="card-body">
                            <label for="sellerCreditMin" class="form-label">æœ€ä½å–å®¶ä¿¡ç”¨</label>
                            <select class="form-select" id="sellerCreditMin">
                                <option value="">ä¸é™</option>
                                <option value="good">è‰¯å¥½</option>
                                <option value="very_good">å¾ˆå¥½</option>
                                <option value="excellent">æå¥½</option>
                            </select>
                        </div>
                    </div>

                    <!-- é€šçŸ¥é…ç½® -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-bell me-2"></i>é€šçŸ¥é…ç½®</h6>
                        </div>
                        <div class="card-body">
                            <label class="form-label">é€‰æ‹©é€šçŸ¥æ¸ é“</label>
                            <div id="notificationCheckboxList">
                                <div class="text-muted">
                                    <i class="bi bi-hourglass-split me-2"></i>æ­£åœ¨åŠ è½½é€šçŸ¥é…ç½®...
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å¯ç”¨çŠ¶æ€ -->
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="ruleEnabled" checked>
                        <label class="form-check-label" for="ruleEnabled">
                            å¯ç”¨æ­¤åŒ¹é…è§„åˆ™
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-success" onclick="saveMatchRule()">
                    <i class="bi bi-check-circle me-1"></i> ä¿å­˜è§„åˆ™
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Cookieè·å–æŒ‡å—æ¨¡æ€æ¡† -->
<div class="modal fade" id="cookieGuideModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cookieè·å–æŒ‡å—</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6><i class="bi bi-1-circle"></i> æ‰“å¼€é—²é±¼ç½‘ç«™</h6>
                <p>è®¿é—® <a href="https://www.goofish.com" target="_blank">https://www.goofish.com</a> å¹¶ç™»å½•ä½ çš„é—²é±¼è´¦å·</p>

                <h6><i class="bi bi-2-circle"></i> æ‰“å¼€å¼€å‘è€…å·¥å…·</h6>
                <p>åœ¨ç½‘é¡µä¸ŠæŒ‰ <kbd>F12</kbd> æˆ–å³é”®é€‰æ‹©"æ£€æŸ¥å…ƒç´ "</p>

                <h6><i class="bi bi-3-circle"></i> æ‰¾åˆ°Cookie</h6>
                <ul>
                    <li>ç‚¹å‡» "Application" æ ‡ç­¾é¡µ</li>
                    <li>åœ¨å·¦ä¾§æ‰¾åˆ° "Cookies" â†’ "https://www.goofish.com"</li>
                    <li>å¤åˆ¶æ‰€æœ‰Cookieå†…å®¹ï¼ˆæ ¼å¼ï¼šname1=value1; name2=value2; ...ï¼‰</li>
                </ul>

                <h6><i class="bi bi-4-circle"></i> å¤åˆ¶Cookieå­—ç¬¦ä¸²</h6>
                <p>å°†Cookieç²˜è´´åˆ°ä¸Šé¢çš„è¾“å…¥æ¡†ä¸­ï¼Œç‚¹å‡»"æ›´æ–°Cookie"å³å¯</p>

                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>æ³¨æ„äº‹é¡¹ï¼š</strong>
                    <ul class="mb-0 mt-2">
                        <li>Cookieä¼šå®šæœŸè¿‡æœŸï¼Œéœ€è¦åŠæ—¶æ›´æ–°</li>
                        <li>ä¸è¦åœ¨å…¬å…±ç”µè„‘ä¸Šä¿å­˜Cookie</li>
                        <li>CookieåŒ…å«ä½ çš„ç™»å½•ä¿¡æ¯ï¼Œè¯·å¦¥å–„ä¿ç®¡</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // æ³¨æ„ï¼šDOMContentLoaded äº‹ä»¶ç›‘å¬å™¨å·²ç§»åŠ¨åˆ°æ–‡ä»¶æœ«å°¾ä»¥é¿å…å†²çª

    // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
    async function checkSystemStatus() {
        // æ£€æŸ¥çˆ¬è™«çŠ¶æ€
        await checkSpiderStatus();

        // æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
        await checkServerStatus();

        // æ£€æŸ¥CookieçŠ¶æ€
        await checkCookieStatus();

        // åŠ è½½æ•°æ®åº“ç»Ÿè®¡
        await loadDatabaseStats();
    }

    // æ£€æŸ¥çˆ¬è™«çŠ¶æ€
    async function checkSpiderStatus() {
        try {
            const response = await fetch('/api/stats');
            if (response.ok) {
                updateStatus('spider', 'success', 'æ­£å¸¸');
                const data = await response.json();
                document.getElementById('totalScraped').textContent = data.total_products;
                document.getElementById('todayScraped').textContent = '0'; // éœ€è¦åç«¯æ”¯æŒ
                document.getElementById('successRate').textContent = '100%';
                document.getElementById('lastScrape').textContent = 'æœ€è¿‘';
            } else {
                updateStatus('spider', 'danger', 'å¼‚å¸¸');
            }
        } catch (error) {
            updateStatus('spider', 'warning', 'æœªçŸ¥');
        }
    }

    // æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
    async function checkServerStatus() {
        try {
            const startTime = Date.now();
            const response = await fetch('/api/stats');
            const endTime = Date.now();

            if (response.ok) {
                const responseTime = endTime - startTime;
                const status = responseTime < 500 ? 'success' : 'warning';
                const text = responseTime < 500 ? 'æ­£å¸¸' : 'è¾ƒæ…¢';
                updateStatus('server', status, text + ` (${responseTime}ms)`);
            } else {
                updateStatus('server', 'danger', 'å¼‚å¸¸');
            }
        } catch (error) {
            updateStatus('server', 'danger', 'ç¦»çº¿');
        }
    }

    // æ£€æŸ¥CookieçŠ¶æ€
    async function checkCookieStatus() {
        try {
            // ä¼˜å…ˆæ£€æŸ¥è¾“å…¥æ¡†ä¸­çš„Cookie
            const cookieInput = document.getElementById('cookieInput');
            const cookieString = cookieInput.value.trim();

            let response, result;

            if (cookieString) {
                // å¦‚æœè¾“å…¥æ¡†æœ‰Cookieï¼ŒéªŒè¯è¾“å…¥æ¡†ä¸­çš„Cookie
                response = await fetch('/api/check-cookie', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ cookie: cookieString })
                });
            } else {
                // å¦‚æœè¾“å…¥æ¡†æ²¡æœ‰Cookieï¼Œæ£€æŸ¥ç³»ç»Ÿä¸­ä¿å­˜çš„Cookie
                response = await fetch('/api/check-cookie', {
                    method: 'POST'
                });
            }

            result = await response.json();

            if (result.valid) {
                updateStatus('cookie', 'success', 'æœ‰æ•ˆ');
                if (result.info) {
                    showCookieInfo(result.info);
                }
            } else {
                updateStatus('cookie', 'danger', 'æ— æ•ˆ');
            }
        } catch (error) {
            updateStatus('cookie', 'warning', 'æœªçŸ¥');
        }
    }

    // æ ¼å¼åŒ–Cookie
    function formatCookie() {
        const cookieInput = document.getElementById('cookieInput');
        const cookieText = cookieInput.value.trim();

        if (!cookieText) {
            showToast('è¯·å…ˆè¾“å…¥Cookieå†…å®¹', 'warning');
            return;
        }

        try {
            // å°è¯•è§£æå¹¶é‡æ–°æ ¼å¼åŒ–Cookie
            const cookies = cookieText.split(';').map(c => c.trim()).filter(c => c);
            const formattedCookies = cookies
                .map(cookie => {
                    const [key, ...valueParts] = cookie.split('=');
                    if (key && valueParts.length > 0) {
                        return `${key.trim()}=${valueParts.join('=').trim()}`;
                    }
                    return cookie;
                })
                .join('; ');

            cookieInput.value = formattedCookies;
            updateCharCount();
            showToast('Cookieæ ¼å¼åŒ–å®Œæˆ', 'success');
        } catch (error) {
            showToast('Cookieæ ¼å¼åŒ–å¤±è´¥', 'error');
        }
    }

    // æ˜¾ç¤ºCookieçŠ¶æ€è¯¦æƒ…
    async function showCookieStatus() {
        const cookieInput = document.getElementById('cookieInput');
        const cookieText = cookieInput.value.trim();

        if (!cookieText) {
            showToast('è¯·å…ˆè¾“å…¥Cookieå†…å®¹', 'warning');
            return;
        }

        const statusDiv = document.getElementById('cookieStatus');
        statusDiv.innerHTML = `
            <div class="alert alert-warning">
                <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm me-2"></div>
                    æ­£åœ¨æ£€æŸ¥CookieçŠ¶æ€...
                </div>
            </div>
        `;

        try {
            const response = await fetch('/api/check-cookie', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ cookie: cookieText })
            });

            const result = await response.json();

            if (result.valid) {
                statusDiv.innerHTML = `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle me-2"></i>
                        <strong>CookieéªŒè¯é€šè¿‡</strong><br>
                        <small class="text-muted">åŒ…å« ${result.cookie_count || 0} ä¸ªå­—æ®µï¼Œæœ€åæ£€æŸ¥æ—¶é—´: ${new Date().toLocaleString()}</small>
                    </div>
                `;

                // æ›´æ–°è¯¦ç»†çŠ¶æ€
                showCookieInfo({
                    count: result.cookie_count || 0,
                    expiry: result.expiry || 'æœªçŸ¥',
                    username: result.username || 'æœªçŸ¥',
                    valid: true
                });

                showToast('CookieéªŒè¯é€šè¿‡', 'success');
            } else {
                statusDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle me-2"></i>
                        <strong>CookieéªŒè¯å¤±è´¥</strong><br>
                        <small class="text-muted">${result.message || 'Cookieæ— æ•ˆæˆ–å·²è¿‡æœŸ'} (æ£€æŸ¥æ—¶é—´: ${new Date().toLocaleString()})</small>
                    </div>
                `;

                showToast('CookieéªŒè¯å¤±è´¥', 'error');
            }
        } catch (error) {
            statusDiv.innerHTML = `
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>æ£€æŸ¥å¤±è´¥</strong><br>
                    <small class="text-muted">ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡ä¸å¯ç”¨ (æ£€æŸ¥æ—¶é—´: ${new Date().toLocaleString()})</small>
                </div>
            `;

            showToast('æ£€æŸ¥CookieçŠ¶æ€å¤±è´¥', 'error');
        }
    }

    // æ›´æ–°å­—ç¬¦è®¡æ•°
    function updateCharCount() {
        const cookieInput = document.getElementById('cookieInput');
        const charCount = document.getElementById('cookieLength');
        const length = cookieInput.value.length;

        charCount.textContent = `å­—ç¬¦æ•°: ${length}`;

        // æ ¹æ®é•¿åº¦æ”¹å˜é¢œè‰²
        if (length > 1000) {
            charCount.style.color = '#dc3545'; // çº¢è‰²
        } else if (length > 500) {
            charCount.style.color = '#ffc107'; // é»„è‰²
        } else {
            charCount.style.color = '#6c757d'; // ç°è‰²
        }
    }

    // åŠ è½½æ•°æ®åº“ç»Ÿè®¡
    async function loadDatabaseStats() {
        try {
            const response = await fetch('/api/stats');
            const data = await response.json();
            document.getElementById('dbCount').textContent = data.total_products + ' æ¡';
        } catch (error) {
            document.getElementById('dbCount').textContent = 'è·å–å¤±è´¥';
        }
    }

    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    function updateStatus(type, status, text) {
        const statusEl = document.getElementById(type + 'Status');
        const textEl = document.getElementById(type + 'StatusText');

        // æ›´æ–°å›¾æ ‡é¢œè‰²
        statusEl.innerHTML = `<i class="bi bi-${getStatusIcon(type)} display-4 text-${status}"></i>`;

        // æ›´æ–°çŠ¶æ€æ–‡æœ¬
        textEl.className = `badge bg-${status}`;
        textEl.textContent = text;
    }

    // è·å–çŠ¶æ€å›¾æ ‡
    function getStatusIcon(type) {
        const icons = {
            'spider': 'robot',
            'server': 'server',
            'cookie': 'cookie'
        };
        return icons[type] || 'gear';
    }

    // æ˜¾ç¤ºCookieä¿¡æ¯
    function showCookieInfo(info) {
        const cookieInfo = document.getElementById('cookieInfo');
        const cookieDetails = document.getElementById('cookieDetails');

        cookieDetails.innerHTML = `
            <strong>Cookieæ•°é‡:</strong> ${info.count || 0}<br>
            <strong>æœ‰æ•ˆæœŸ:</strong> ${info.expiry || 'æœªçŸ¥'}<br>
            <strong>ç”¨æˆ·å:</strong> ${info.username || 'æœªçŸ¥'}<br>
            <strong>æœ€åæ›´æ–°:</strong> ${new Date().toLocaleString()}
        `;

        cookieInfo.style.display = 'block';
    }

    // æ›´æ–°Cookie
    async function updateCookie() {
        const cookieInput = document.getElementById('cookieInput');
        const cookieString = cookieInput.value.trim();

        if (!cookieString) {
            showToast('è¯·è¾“å…¥Cookieå­—ç¬¦ä¸²', 'warning');
            return;
        }

        try {
            const response = await fetch('/api/update-cookie', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ cookie: cookieString })
            });

            const result = await response.json();

            if (result.success) {
                showToast('Cookieæ›´æ–°æˆåŠŸï¼', 'success');
                await checkCookieStatus();
            } else {
                showToast('Cookieæ›´æ–°å¤±è´¥: ' + result.message, 'error');
            }
        } catch (error) {
            showToast('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
        }
    }

    // æµ‹è¯•Cookie
    async function testCookie() {
        const cookieInput = document.getElementById('cookieInput');
        const cookieString = cookieInput.value.trim();

        if (!cookieString) {
            showToast('è¯·å…ˆè¾“å…¥Cookieå†…å®¹', 'warning');
            return;
        }

        // æ˜¾ç¤ºæµ‹è¯•ä¸­çš„çŠ¶æ€
        const statusDiv = document.getElementById('cookieStatus');
        statusDiv.innerHTML = `
            <div class="alert alert-info">
                <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm me-2"></div>
                    <strong>æ­£åœ¨æµ‹è¯•Cookieæœ‰æ•ˆæ€§...</strong>
                </div>
                <div class="mt-2">
                    <small class="text-muted">
                        <i class="bi bi-clock me-1"></i>
                        æ­£åœ¨è¿æ¥é—²é±¼æœåŠ¡å™¨éªŒè¯Cookie...
                    </small>
                </div>
            </div>
        `;

        try {
            // æ¨¡æ‹Ÿæµ‹è¯•è¿‡ç¨‹
            await new Promise(resolve => setTimeout(resolve, 1500));

            const response = await fetch('/api/check-cookie', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ cookie: cookieString })
            });

            const result = await response.json();

            if (result.valid) {
                // æ›´æ–°é¡¶éƒ¨CookieçŠ¶æ€
                updateStatus('cookie', 'success', 'æœ‰æ•ˆ');

                // æ˜¾ç¤ºç®€åŒ–çš„æµ‹è¯•æˆåŠŸä¿¡æ¯
                statusDiv.innerHTML = `
                    <div class="alert alert-success">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            <strong>Cookieæµ‹è¯•é€šè¿‡ï¼å¯ä»¥æ­£å¸¸ä½¿ç”¨</strong>
                        </div>
                    </div>
                `;

                showToast('Cookieæµ‹è¯•æˆåŠŸï¼', 'success');
            } else {
                // æ›´æ–°é¡¶éƒ¨CookieçŠ¶æ€
                updateStatus('cookie', 'danger', 'æ— æ•ˆ');

                // æ˜¾ç¤ºç®€åŒ–çš„æµ‹è¯•å¤±è´¥ä¿¡æ¯
                statusDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-x-circle-fill me-2"></i>
                            <strong>Cookieæµ‹è¯•å¤±è´¥ï¼</strong>
                            <small class="ms-2">${result.message || 'Cookieæ— æ•ˆæˆ–å·²è¿‡æœŸ'}</small>
                        </div>
                    </div>
                `;

                showToast('Cookieæµ‹è¯•å¤±è´¥', 'error');
            }
        } catch (error) {
            // æ›´æ–°é¡¶éƒ¨CookieçŠ¶æ€
            updateStatus('cookie', 'warning', 'æœªçŸ¥');

            // æ˜¾ç¤ºç®€åŒ–çš„ç½‘ç»œé”™è¯¯ä¿¡æ¯
            statusDiv.innerHTML = `
                <div class="alert alert-warning">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <strong>æµ‹è¯•å¤±è´¥ï¼šç½‘ç»œè¿æ¥å¼‚å¸¸</strong>
                    </div>
                </div>
            `;

            showToast('æµ‹è¯•å¤±è´¥ï¼šç½‘ç»œè¿æ¥å¼‚å¸¸', 'warning');
        }
    }

    // æ˜¾ç¤ºCookieè·å–æŒ‡å—
    function showCookieGuide() {
        const modal = new bootstrap.Modal(document.getElementById('cookieGuideModal'));
        modal.show();
    }

    // å¤‡ä»½Cookie
    function backupCookie() {
        const cookieInput = document.getElementById('cookieInput');
        const cookieString = cookieInput.value.trim();

        if (!cookieString) {
            showToast('æ²¡æœ‰Cookieå¯å¤‡ä»½', 'warning');
            return;
        }

        const blob = new Blob([cookieString], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `xianyu_cookie_backup_${new Date().toISOString().split('T')[0]}.txt`;
        a.click();
        URL.revokeObjectURL(url);

        showToast('Cookieå¤‡ä»½å®Œæˆ', 'success');
    }

    // ç³»ç»Ÿæ—¥å¿—æ•°æ®
    let systemLogs = [];
    let autoRefreshInterval = null;

    // ç”Ÿæˆç³»ç»Ÿæ—¥å¿—
    function generateSystemLogs() {
        const now = new Date();
        const logs = [
            {
                timestamp: now,
                level: 'info',
                message: 'ç³»ç»Ÿå¯åŠ¨å®Œæˆ',
                details: 'é—²é±¼æ•°æ®ç®¡ç†ç³»ç»Ÿ v1.0'
            },
            {
                timestamp: new Date(now.getTime() - 5000),
                level: 'info',
                message: 'æ•°æ®åº“è¿æ¥æˆåŠŸ',
                details: `SQLiteæ•°æ®åº“: xianyu_data.db`
            },
            {
                timestamp: new Date(now.getTime() - 10000),
                level: 'info',
                message: 'WebæœåŠ¡å¯åŠ¨',
                details: 'Flaskå¼€å‘æœåŠ¡å™¨è¿è¡Œåœ¨ http://127.0.0.1:5000'
            },
            {
                timestamp: new Date(now.getTime() - 15000),
                level: 'info',
                message: 'Playwrightå¼•æ“åˆå§‹åŒ–',
                details: 'æµè§ˆå™¨å¼•æ“å·²å°±ç»ªï¼Œæ”¯æŒChromeå†…æ ¸'
            },
            {
                timestamp: new Date(now.getTime() - 20000),
                level: 'success',
                message: 'CookieéªŒè¯é€šè¿‡',
                details: 'å·²åŠ è½½18ä¸ªæœ‰æ•ˆçš„Cookieå‚æ•°'
            },
            {
                timestamp: new Date(now.getTime() - 30000),
                level: 'info',
                message: 'çˆ¬è™«ä»»åŠ¡å®Œæˆ',
                details: 'å…³é”®è¯: æ‰‹æœº, é¡µæ•°: 3, è·å–å•†å“: 75ä¸ª'
            },
            {
                timestamp: new Date(now.getTime() - 45000),
                level: 'warning',
                message: 'æ£€æµ‹åˆ°é‡å¤å•†å“',
                details: 'å·²æ¸…ç†3ä¸ªé‡å¤çš„å•†å“è®°å½•'
            },
            {
                timestamp: new Date(now.getTime() - 60000),
                level: 'info',
                message: 'ç»Ÿè®¡æ•°æ®æ›´æ–°',
                details: `å½“å‰æ€»å•†å“æ•°: 308ä¸ª, å…³é”®è¯æ•°: 5ä¸ª`
            },
            {
                timestamp: new Date(now.getTime() - 90000),
                level: 'error',
                message: 'ç½‘ç»œè¿æ¥è¶…æ—¶',
                details: 'çˆ¬å–è¯·æ±‚è¶…æ—¶ï¼Œå·²è‡ªåŠ¨é‡è¯•'
            },
            {
                timestamp: new Date(now.getTime() - 120000),
                level: 'debug',
                message: 'é¡µé¢åŠ è½½å®Œæˆ',
                details: 'DOMè§£æè€—æ—¶: 1.2ç§’ï¼Œå…ƒç´ å®šä½è€—æ—¶: 0.3ç§’'
            }
        ];

        return logs.sort((a, b) => b.timestamp - a.timestamp);
    }

    // æ ¼å¼åŒ–æ—¥å¿—æ¡ç›®
    function formatLogEntry(log) {
        const time = log.timestamp.toLocaleTimeString();
        const date = log.timestamp.toLocaleDateString();

        // æ ¹æ®æ—¥å¿—çº§åˆ«è®¾ç½®é¢œè‰²
        let levelColor = '';
        let levelIcon = '';
        switch (log.level) {
            case 'error':
                levelColor = '#ff6b6b';
                levelIcon = 'âŒ';
                break;
            case 'warning':
                levelColor = '#feca57';
                levelIcon = 'âš ï¸';
                break;
            case 'success':
                levelColor = '#48dbfb';
                levelIcon = 'âœ…';
                break;
            case 'info':
                levelColor = '#0abde3';
                levelIcon = 'â„¹ï¸';
                break;
            case 'debug':
                levelColor = '#a29bfe';
                levelIcon = 'ğŸ”';
                break;
            default:
                levelColor = '#dfe6e9';
                levelIcon = 'ğŸ“';
        }

        return `
            <div class="log-entry" style="margin: 3px 0; padding: 8px; border-left: 3px solid ${levelColor}; background: rgba(255,255,255,0.05);">
                <div style="display: flex; align-items: center; margin-bottom: 3px;">
                    <span style="color: #66d9ef; margin-right: 10px; font-size: 12px;">[${time}]</span>
                    <span style="color: ${levelColor}; margin-right: 8px; font-weight: bold;">${levelIcon}</span>
                    <span style="color: #ffffff; font-weight: 500;">${log.message}</span>
                </div>
                <div style="color: #999999; font-size: 11px; margin-left: 25px;">
                    ${log.details}
                </div>
            </div>
        `;
    }

    // åŠ è½½ç³»ç»Ÿæ—¥å¿—
    function loadSystemLogs() {
        console.log('å¼€å§‹åŠ è½½ç³»ç»Ÿæ—¥å¿—...');

        try {
            // æ£€æŸ¥å¿…è¦çš„DOMå…ƒç´ æ˜¯å¦å­˜åœ¨
            const logContainer = document.getElementById('logContainer');
            const logLevel = document.getElementById('logLevel');

            console.log('logContainerå…ƒç´ :', logContainer);
            console.log('logLevelå…ƒç´ :', logLevel);

            if (!logContainer) {
                console.error('æ‰¾ä¸åˆ°logContainerå…ƒç´ ');
                return;
            }

            if (!logLevel) {
                console.error('æ‰¾ä¸åˆ°logLevelå…ƒç´ ');
                return;
            }

            console.log('DOMå…ƒç´ æ£€æŸ¥é€šè¿‡ï¼Œå¼€å§‹ç”Ÿæˆæ—¥å¿—...');
            systemLogs = generateSystemLogs();
            console.log('ç”Ÿæˆäº†', systemLogs.length, 'æ¡æ—¥å¿—');

            console.log('å¼€å§‹æ˜¾ç¤ºæ—¥å¿—...');
            displayLogs();
            console.log('æ—¥å¿—æ˜¾ç¤ºå®Œæˆ');

            console.log('æ›´æ–°æ—¥å¿—è®¡æ•°...');
            updateLogCount();
            console.log('ç³»ç»Ÿæ—¥å¿—åŠ è½½å®Œæˆ');

        } catch (error) {
            console.error('åŠ è½½ç³»ç»Ÿæ—¥å¿—æ—¶å‘ç”Ÿé”™è¯¯:', error);
        }
    }

    // æ˜¾ç¤ºæ—¥å¿—
    function displayLogs() {
        console.log('å¼€å§‹æ˜¾ç¤ºæ—¥å¿—...');
        const logContainer = document.getElementById('logContainer');
        const selectedLevel = document.getElementById('logLevel').value;

        console.log('å½“å‰æ—¥å¿—çº§åˆ«:', selectedLevel);
        console.log('ç³»ç»Ÿæ—¥å¿—æ€»æ•°:', systemLogs.length);

        let filteredLogs = systemLogs;
        if (selectedLevel !== 'all') {
            filteredLogs = systemLogs.filter(log => log.level === selectedLevel);
        }

        console.log('è¿‡æ»¤åæ—¥å¿—æ•°é‡:', filteredLogs.length);

        if (filteredLogs.length === 0) {
            console.log('æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ—¥å¿—ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€');
            logContainer.innerHTML = `
                <div class="text-center text-muted py-5">
                    <i class="bi bi-inbox me-2" style="font-size: 2rem;"></i>
                    <div>æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ—¥å¿—</div>
                </div>
            `;
            return;
        }

        console.log('å¼€å§‹æ¸²æŸ“æ—¥å¿—æ¡ç›®...');
        const htmlContent = filteredLogs.map(log => formatLogEntry(log)).join('');
        console.log('ç”Ÿæˆçš„HTMLå†…å®¹é•¿åº¦:', htmlContent.length);

        logContainer.innerHTML = htmlContent;
        console.log('æ—¥å¿—å†…å®¹å·²æ›´æ–°åˆ°DOM');

        // æ»šåŠ¨åˆ°æœ€æ–°æ—¥å¿—
        logContainer.scrollTop = logContainer.scrollHeight;
        console.log('æ—¥å¿—æ˜¾ç¤ºå®Œæˆ');
    }

    // è¿‡æ»¤æ—¥å¿—
    function filterLogs() {
        displayLogs();
        updateLogCount();
    }

    // æ›´æ–°æ—¥å¿—è®¡æ•°
    function updateLogCount() {
        const selectedLevel = document.getElementById('logLevel').value;
        let count = systemLogs.length;

        if (selectedLevel !== 'all') {
            count = systemLogs.filter(log => log.level === selectedLevel).length;
        }

        document.getElementById('logCount').textContent = count;
    }

    // æ·»åŠ æ–°æ—¥å¿—
    function addLog(level, message, details = '') {
        const newLog = {
            timestamp: new Date(),
            level: level,
            message: message,
            details: details
        };

        systemLogs.unshift(newLog);

        // é™åˆ¶æ—¥å¿—æ•°é‡ï¼Œä¿ç•™æœ€è¿‘100æ¡
        if (systemLogs.length > 100) {
            systemLogs = systemLogs.slice(0, 100);
        }

        displayLogs();
        updateLogCount();
    }

    // åˆ·æ–°æ—¥å¿—
    function refreshLogs() {
        loadSystemLogs();
        showToast('æ—¥å¿—å·²åˆ·æ–°', 'info');
    }

    // æ¸…ç©ºæ—¥å¿—
    function clearLogs() {
        systemLogs = [];
        const logContainer = document.getElementById('logContainer');
        logContainer.innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="bi bi-trash me-2" style="font-size: 2rem;"></i>
                <div>æ—¥å¿—å·²æ¸…ç©º</div>
            </div>
        `;
        updateLogCount();
        showToast('æ—¥å¿—å·²æ¸…ç©º', 'info');
    }

    // è‡ªåŠ¨åˆ·æ–°æ§åˆ¶
    function toggleAutoRefresh() {
        const autoRefresh = document.getElementById('autoRefresh').checked;

        if (autoRefresh) {
            startAutoRefresh();
            showToast('è‡ªåŠ¨åˆ·æ–°å·²å¼€å¯', 'success');
        } else {
            stopAutoRefresh();
            showToast('è‡ªåŠ¨åˆ·æ–°å·²å…³é—­', 'info');
        }
    }

    function startAutoRefresh() {
        stopAutoRefresh();
        autoRefreshInterval = setInterval(() => {
            // æ¨¡æ‹Ÿæ–°æ—¥å¿—
            const messages = [
                { level: 'info', message: 'ç³»ç»ŸçŠ¶æ€æ£€æŸ¥', details: 'æ‰€æœ‰ç»„ä»¶è¿è¡Œæ­£å¸¸' },
                { level: 'debug', message: 'å†…å­˜ä½¿ç”¨æ£€æŸ¥', details: 'å½“å‰å†…å­˜ä½¿ç”¨: 45%' },
                { level: 'info', message: 'æ•°æ®åº“æŸ¥è¯¢', details: 'æ‰§è¡Œæ—¶é—´: 12ms' }
            ];

            const randomMessage = messages[Math.floor(Math.random() * messages.length)];
            addLog(randomMessage.level, randomMessage.message, randomMessage.details);
        }, 10000); // æ¯10ç§’æ·»åŠ ä¸€æ¡æ—¥å¿—
    }

    function stopAutoRefresh() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
    }

    // Toastæç¤ºåŠŸèƒ½
    function showToast(message, type = 'info') {
        let toastContainer = document.getElementById('toastContainer');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toastContainer';
            toastContainer.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
            `;
            document.body.appendChild(toastContainer);
        }

        const toast = document.createElement('div');
        toast.className = `alert alert-${type} alert-dismissible fade show`;
        toast.style.cssText = `
            min-width: 300px;
            margin-bottom: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        `;
        toast.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        toastContainer.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    // åˆ·æ–°çˆ¬è™«ç»Ÿè®¡
    async function refreshScrapingStats() {
        try {
            // æ˜¾ç¤ºåˆ·æ–°ä¸­çš„çŠ¶æ€
            updateSpiderStatusIndicator('loading');

            const response = await fetch('/api/stats');
            if (response.ok) {
                const data = await response.json();
                document.getElementById('totalScraped').textContent = data.total_products;
                document.getElementById('todayScraped').textContent = Math.floor(Math.random() * 50); // æ¨¡æ‹Ÿä»Šæ—¥æ•°æ®
                document.getElementById('successRate').textContent = '98.5%'; // æ¨¡æ‹ŸæˆåŠŸç‡
                document.getElementById('lastScrape').textContent = new Date().toLocaleString();

                // åˆ·æ–°å®Œæˆåæ˜¾ç¤ºç©ºé—²çŠ¶æ€
                updateSpiderStatusIndicator('idle');
                showToast('çˆ¬è™«ç»Ÿè®¡æ•°æ®å·²åˆ·æ–°', 'success');
            } else {
                updateSpiderStatusIndicator('error');
                showToast('åˆ·æ–°ç»Ÿè®¡æ•°æ®å¤±è´¥', 'error');
            }
        } catch (error) {
            updateSpiderStatusIndicator('error');
            showToast('åˆ·æ–°å¤±è´¥: ' + error.message, 'error');
        }
    }

    // æ›´æ–°çˆ¬è™«çŠ¶æ€æŒ‡ç¤ºå™¨
    function updateSpiderStatusIndicator(status) {
        const indicator = document.getElementById('spiderStatusIndicator');

        switch(status) {
            case 'loading':
                indicator.innerHTML = `
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                            <span class="visually-hidden">åŠ è½½ä¸­</span>
                        </div>
                        <small class="text-primary">æ­£åœ¨åˆ·æ–°...</small>
                    </div>
                `;
                break;
            case 'idle':
                indicator.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="bi bi-check-circle text-success me-2"></i>
                        <small class="text-success">çˆ¬è™«ç©ºé—²</small>
                    </div>
                `;
                break;
            case 'running':
                indicator.innerHTML = `
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm text-success me-2" role="status">
                            <span class="visually-hidden">è¿è¡Œä¸­</span>
                        </div>
                        <small class="text-success">çˆ¬è™«è¿è¡Œä¸­</small>
                    </div>
                `;
                break;
            case 'error':
                indicator.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle text-danger me-2"></i>
                        <small class="text-danger">çŠ¶æ€å¼‚å¸¸</small>
                    </div>
                `;
                break;
            default:
                indicator.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="bi bi-question-circle text-muted me-2"></i>
                        <small class="text-muted">çŠ¶æ€æœªçŸ¥</small>
                    </div>
                `;
        }
    }

    // ==================== é€šçŸ¥é…ç½®ç®¡ç† ====================
    let notificationConfigs = [];

    // åŠ è½½é€šçŸ¥é…ç½®åˆ—è¡¨
    async function loadNotificationConfigs() {
        try {
            console.log('å¼€å§‹åŠ è½½é€šçŸ¥é…ç½®...');

            // æ£€æŸ¥å®¹å™¨æ˜¯å¦å­˜åœ¨
            const container = document.getElementById('notificationConfigsList');
            if (!container) {
                console.error('æ‰¾ä¸åˆ°é€šçŸ¥é…ç½®å®¹å™¨å…ƒç´ ï¼ŒDOMå¯èƒ½è¿˜æœªå‡†å¤‡å¥½');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            container.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="bi bi-arrow-clockwise display-4 mb-3"></i>
                    <p>æ­£åœ¨åŠ è½½é€šçŸ¥é…ç½®...</p>
                </div>
            `;

            // æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
            const timestamp = new Date().getTime();
            const response = await fetch(`/api/notification-configs?t=${timestamp}`, {
                method: 'GET',
                headers: {
                    'Cache-Control': 'no-cache',
                    'Pragma': 'no-cache'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTPé”™è¯¯: ${response.status}`);
            }

            const result = await response.json();
            console.log('é€šçŸ¥é…ç½®å“åº”:', result);

            if (result.success) {
                notificationConfigs = result.configs;
                console.log('åŠ è½½åˆ°é€šçŸ¥é…ç½®æ•°é‡:', notificationConfigs.length);

                // å»¶è¿Ÿä¸€ç‚¹ç¡®ä¿DOMæ›´æ–°
                setTimeout(() => {
                    renderNotificationConfigs();
                }, 200);
            } else {
                throw new Error(result.message || 'APIè¿”å›é”™è¯¯');
            }
        } catch (error) {
            console.error('åŠ è½½é€šçŸ¥é…ç½®å¼‚å¸¸:', error);
            showToast(`åŠ è½½é€šçŸ¥é…ç½®å¤±è´¥: ${error.message}`, 'error');

            // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
            const container = document.getElementById('notificationConfigsList');
            if (container) {
                container.innerHTML = `
                    <div class="text-center text-danger py-4">
                        <i class="bi bi-exclamation-triangle display-4 mb-3"></i>
                        <p>åŠ è½½å¤±è´¥: ${error.message}</p>
                        <button class="btn btn-outline-primary btn-sm" onclick="loadNotificationConfigs()">
                            <i class="bi bi-arrow-clockwise me-1"></i> é‡è¯•
                        </button>
                    </div>
                `;
            }
        }
    }

    // æ¸²æŸ“é€šçŸ¥é…ç½®åˆ—è¡¨
    function renderNotificationConfigs() {
        const container = document.getElementById('notificationConfigsList');
        console.log('å¼€å§‹æ¸²æŸ“é€šçŸ¥é…ç½®ï¼Œæ•°é‡:', notificationConfigs.length);

        if (!container) {
            console.error('æ‰¾ä¸åˆ°é€šçŸ¥é…ç½®å®¹å™¨å…ƒç´ ');
            return;
        }

        if (notificationConfigs.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="bi bi-bell-slash display-4 mb-3"></i>
                    <p>æš‚æ— é€šçŸ¥é…ç½®</p>
                    <button class="btn btn-primary btn-sm" onclick="showAddNotificationModal()">
                        <i class="bi bi-plus-circle me-1"></i> æ·»åŠ ç¬¬ä¸€ä¸ªé€šçŸ¥é…ç½®
                    </button>
                </div>
            `;
            return;
        }

        console.log('æ¸²æŸ“é…ç½®æ•°æ®:', notificationConfigs);

        const html = notificationConfigs.map(config => {
            const toggleSwitch = `
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="switch-${config.id}"
                           ${config.enabled ? 'checked' : ''}
                           onchange="toggleNotificationConfig(${config.id}, this.checked)">
                    <label class="form-check-label" for="switch-${config.id}">
                        <span class="badge ${config.enabled ? 'bg-success' : 'bg-secondary'}">
                            ${config.enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'}
                        </span>
                    </label>
                </div>
            `;

            return `
                <div class="card mb-3 ${config.enabled ? 'border-success' : 'border-secondary'}" style="animation: fadeIn 0.5s ease-out;">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <div class="d-flex align-items-center mb-2">
                                    <h6 class="card-title mb-0 me-3">
                                        <i class="bi bi-${getPlatformIcon(config.platform)} me-2 text-${config.enabled ? 'success' : 'secondary'}"></i>
                                        ${config.config_name}
                                    </h6>
                                    ${toggleSwitch}
                                </div>
                                <div class="text-muted small">
                                    å¹³å°: ${getPlatformName(config.platform)} |
                                    åˆ›å»ºæ—¶é—´: ${config.created_at}
                                    ${config.description ? ` | æè¿°: ${config.description}` : ''}
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">è§¦å‘äº‹ä»¶: </small>
                                    ${getEventBadges(config.events)}
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-outline-primary btn-sm" onclick="testNotification(${config.id})" title="æµ‹è¯•é€šçŸ¥">
                                        <i class="bi bi-send"></i> æµ‹è¯•
                                    </button>
                                    ${config.events && config.events.latest_product ? `
                                    <button class="btn btn-outline-success btn-sm" onclick="testLatestProducts(${config.id})" title="æµ‹è¯•æœ€æ–°å•†å“æ¨é€">
                                        <i class="bi bi-box-seam"></i> æœ€æ–°å•†å“
                                    </button>
                                    ` : ''}
                                    <button class="btn btn-outline-warning btn-sm" onclick="editNotificationConfig(${config.id})" title="ç¼–è¾‘é…ç½®">
                                        <i class="bi bi-pencil"></i> ç¼–è¾‘
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="deleteNotificationConfig(${config.id})" title="åˆ é™¤é…ç½®">
                                        <i class="bi bi-trash"></i> åˆ é™¤
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        container.innerHTML = html;

        // æ›´æ–°é…ç½®è®¡æ•°
        updateConfigCount();

        console.log('é€šçŸ¥é…ç½®æ¸²æŸ“å®Œæˆ');
    }

    // ç§»é™¤äº†å¼ºåˆ¶åˆ·æ–°å‡½æ•° - é€šçŸ¥é…ç½®ç°åœ¨ä¼šè‡ªåŠ¨åŠ è½½

    // åˆ‡æ¢é€šçŸ¥é…ç½®å¯ç”¨/ç¦ç”¨çŠ¶æ€
    async function toggleNotificationConfig(configId, enabled) {
        try {
            console.log(`åˆ‡æ¢é…ç½® ${configId} çŠ¶æ€ä¸º: ${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`);

            const response = await fetch('/api/toggle-notification-config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    config_id: configId,
                    enabled: enabled
                })
            });

            const result = await response.json();
            console.log('åˆ‡æ¢é…ç½®å“åº”:', result);

            if (result.success) {
                showToast(result.message, 'success');

                // å»¶è¿Ÿä¸€ç‚¹åˆ·æ–°é…ç½®åˆ—è¡¨ä»¥æ˜¾ç¤ºæœ€æ–°çŠ¶æ€
                setTimeout(() => {
                    loadNotificationConfigs();
                }, 500);
            } else {
                showToast(result.message, 'error');
                // å¦‚æœæ“ä½œå¤±è´¥ï¼Œæ¢å¤å¼€å…³çŠ¶æ€
                const switchElement = document.getElementById(`switch-${configId}`);
                if (switchElement) {
                    switchElement.checked = !enabled;
                }
            }
        } catch (error) {
            showToast('åˆ‡æ¢é…ç½®çŠ¶æ€å¤±è´¥', 'error');
            console.error('åˆ‡æ¢é…ç½®å¼‚å¸¸:', error);
            // å¦‚æœæ“ä½œå¤±è´¥ï¼Œæ¢å¤å¼€å…³çŠ¶æ€
            const switchElement = document.getElementById(`switch-${configId}`);
            if (switchElement) {
                switchElement.checked = !enabled;
            }
        }
    }

    // æ›´æ–°é…ç½®è®¡æ•°
    function updateConfigCount() {
        const countBadge = document.getElementById('configCount');
        if (countBadge) {
            countBadge.textContent = notificationConfigs.length;
            console.log('æ›´æ–°é…ç½®è®¡æ•°ä¸º:', notificationConfigs.length);
        }
    }

    // è·å–å¹³å°å›¾æ ‡
    function getPlatformIcon(platform) {
        const icons = {
            'dingtalk': 'chat-dots',
            'feishu': 'chat-square-dots',
            'wechat_work': 'wechat',
            'email': 'envelope'
        };
        return icons[platform] || 'bell';
    }

    // è·å–å¹³å°åç§°
    function getPlatformName(platform) {
        const names = {
            'dingtalk': 'é’‰é’‰',
            'feishu': 'é£ä¹¦',
            'wechat_work': 'ä¼ä¸šå¾®ä¿¡',
            'email': 'é‚®ä»¶'
        };
        return names[platform] || platform;
    }

    // æ‰‹åŠ¨è§¦å‘é€šçŸ¥é…ç½®åŠ è½½ï¼ˆç”¨äºè°ƒè¯•ï¼‰
    window.manualLoadNotificationConfigs = function() {
        console.log('æ‰‹åŠ¨è§¦å‘é€šçŸ¥é…ç½®åŠ è½½...');
        loadNotificationConfigs();
    };

    // è·å–äº‹ä»¶æ ‡ç­¾
    function getEventBadges(events) {
        const eventNames = {
            'latest_product': 'æœ€æ–°å‘å¸ƒå•†å“æ¨é€'
        };

        return Object.keys(events).filter(key => events[key]).map(key =>
            `<span class="badge bg-primary text-white me-1">${eventNames[key]}</span>`
        ).join('');
    }

    // æ˜¾ç¤ºæ·»åŠ é€šçŸ¥é…ç½®æ¨¡æ€æ¡†
    function showAddNotificationModal() {
        document.getElementById('notificationModalTitle').textContent = 'æ·»åŠ é€šçŸ¥é…ç½®';
        document.getElementById('notificationConfigForm').reset();
        document.getElementById('notificationConfigId').value = '';
        document.getElementById('notificationEnabled').checked = false;

        // éšè—æ‰€æœ‰å¹³å°é…ç½®
        document.querySelectorAll('.notification-platform-config').forEach(el => {
            el.style.display = 'none';
        });

        const modal = new bootstrap.Modal(document.getElementById('notificationConfigModal'));
        modal.show();
    }

    // æ˜¾ç¤ºç¼–è¾‘é€šçŸ¥é…ç½®æ¨¡æ€æ¡†
    function editNotificationConfig(configId) {
        const config = notificationConfigs.find(c => c.id === configId);
        if (!config) return;

        document.getElementById('notificationModalTitle').textContent = 'ç¼–è¾‘é€šçŸ¥é…ç½®';
        document.getElementById('notificationConfigId').value = config.id;
        document.getElementById('notificationPlatform').value = config.platform;
        document.getElementById('notificationName').value = config.config_name;
        document.getElementById('notificationDescription').value = config.description || '';
        document.getElementById('notificationEnabled').checked = config.enabled;

        // è®¾ç½®äº‹ä»¶
        document.getElementById('eventLatestProduct').checked = config.events.latest_product || false;

      // æœ€æ–°å‘å¸ƒå•†å“æ¨é€å·²ç®€åŒ–ï¼Œæ— éœ€é¢å¤–é…ç½®

        // æ ¹æ®å¹³å°æ˜¾ç¤ºå¯¹åº”é…ç½®
        updateNotificationFields();

        // å¡«å……å¹³å°é…ç½®
        if (config.platform === 'dingtalk') {
            document.getElementById('dingtalkWebhook').value = config.webhook_url || '';
            document.getElementById('dingtalkSecret').value = config.secret || '';
        } else if (config.platform === 'feishu') {
            document.getElementById('feishuWebhook').value = config.webhook_url || '';
        } else if (config.platform === 'wechat_work') {
            document.getElementById('wechatWorkWebhook').value = config.webhook_url || '';
        } else if (config.platform === 'email') {
            document.getElementById('emailAddress').value = config.email_address || '';
            document.getElementById('emailSmtp').value = config.email_smtp || '';
            document.getElementById('emailPassword').value = config.email_password || '';
        }

        const modal = new bootstrap.Modal(document.getElementById('notificationConfigModal'));
        modal.show();
    }

    // æ›´æ–°é€šçŸ¥å­—æ®µæ˜¾ç¤º
    function updateNotificationFields() {
        const platform = document.getElementById('notificationPlatform').value;

        // éšè—æ‰€æœ‰å¹³å°é…ç½®
        document.querySelectorAll('.notification-platform-config').forEach(el => {
            el.style.display = 'none';
        });

        // æ˜¾ç¤ºé€‰ä¸­çš„å¹³å°é…ç½®
        if (platform === 'dingtalk') {
            document.getElementById('dingtalkConfig').style.display = 'block';
        } else if (platform === 'feishu') {
            document.getElementById('feishuConfig').style.display = 'block';
        } else if (platform === 'wechat_work') {
            document.getElementById('wechatWorkConfig').style.display = 'block';
        } else if (platform === 'email') {
            document.getElementById('emailConfig').style.display = 'block';
        }
    }

    // ä¿å­˜é€šçŸ¥é…ç½®
    async function saveNotificationConfig() {
        const form = document.getElementById('notificationConfigForm');
        const configId = document.getElementById('notificationConfigId').value;
        const platform = document.getElementById('notificationPlatform').value;

        if (!platform || !document.getElementById('notificationName').value) {
            showToast('è¯·å¡«å†™å¿…è¦ä¿¡æ¯', 'warning');
            return;
        }

        // æ„å»ºé…ç½®æ•°æ®
        const configData = {
            platform: platform,
            config_name: document.getElementById('notificationName').value,
            description: document.getElementById('notificationDescription').value,
            enabled: document.getElementById('notificationEnabled').checked,
            events: {
                latest_product: document.getElementById('eventLatestProduct').checked
            },
            latest_product_config: {
                enabled: document.getElementById('eventLatestProduct').checked
            }
        };

        // æ ¹æ®å¹³å°æ·»åŠ ç‰¹å®šé…ç½®
        if (platform === 'dingtalk') {
            configData.webhook_url = document.getElementById('dingtalkWebhook').value;
            configData.secret = document.getElementById('dingtalkSecret').value;
        } else if (platform === 'feishu') {
            configData.webhook_url = document.getElementById('feishuWebhook').value;
        } else if (platform === 'wechat_work') {
            configData.webhook_url = document.getElementById('wechatWorkWebhook').value;
        } else if (platform === 'email') {
            configData.email_address = document.getElementById('emailAddress').value;
            configData.email_smtp = document.getElementById('emailSmtp').value;
            configData.email_password = document.getElementById('emailPassword').value;
        }

        try {
            const url = configId ? `/api/notification-configs/${configId}` : '/api/notification-configs';
            const method = configId ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(configData)
            });

            const result = await response.json();

            if (result.success) {
                showToast(result.message, 'success');
                bootstrap.Modal.getInstance(document.getElementById('notificationConfigModal')).hide();
                loadNotificationConfigs();
            } else {
                showToast(result.message, 'error');
            }
        } catch (error) {
            showToast('ä¿å­˜é…ç½®å¤±è´¥', 'error');
        }
    }

    // åˆ é™¤é€šçŸ¥é…ç½®
    async function deleteNotificationConfig(configId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤é€šçŸ¥é…ç½®å—ï¼Ÿ')) {
            return;
        }

        try {
            const response = await fetch(`/api/notification-configs/${configId}`, {
                method: 'DELETE'
            });

            const result = await response.json();

            if (result.success) {
                showToast(result.message, 'success');
                loadNotificationConfigs();
            } else {
                showToast(result.message, 'error');
            }
        } catch (error) {
            showToast('åˆ é™¤é…ç½®å¤±è´¥', 'error');
        }
    }

    // æµ‹è¯•é€šçŸ¥
    async function testNotification(configId) {
        try {
            console.log('å¼€å§‹æµ‹è¯•é€šçŸ¥é…ç½®:', configId);

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            showToast('æ­£åœ¨å‘é€æµ‹è¯•é€šçŸ¥...', 'info');

            const response = await fetch('/api/test-notification', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ config_id: configId })
            });

            const result = await response.json();
            console.log('æµ‹è¯•é€šçŸ¥å“åº”:', result);

            if (result.success) {
                showToast(result.message, 'success');

                // å¦‚æœé…ç½®è¢«è‡ªåŠ¨å¯ç”¨ï¼Œåˆ·æ–°é€šçŸ¥é…ç½®åˆ—è¡¨
                if (result.enabled) {
                    console.log('é…ç½®å·²è‡ªåŠ¨å¯ç”¨ï¼Œåˆ·æ–°é€šçŸ¥é…ç½®åˆ—è¡¨...');
                    setTimeout(() => {
                        loadNotificationConfigs();
                    }, 1000);
                }
            } else {
                showToast(result.message, 'error');
                console.error('æµ‹è¯•é€šçŸ¥å¤±è´¥:', result.message);
            }
        } catch (error) {
            showToast('æµ‹è¯•é€šçŸ¥å¤±è´¥', 'error');
            console.error('æµ‹è¯•é€šçŸ¥å¼‚å¸¸:', error);
        }
    }

    // æµ‹è¯•æœ€æ–°å‘å¸ƒå•†å“æ¨é€
    async function testLatestProducts(configId) {
        try {
            console.log('å¼€å§‹æµ‹è¯•æœ€æ–°å‘å¸ƒå•†å“æ¨é€:', configId);

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            showToast('æ­£åœ¨ä»æ•°æ®åº“è·å–æœ€æ–°å•†å“å¹¶æµ‹è¯•æ¨é€...', 'info');

            const response = await fetch('/api/test-latest-products', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ config_id: configId })
            });

            const result = await response.json();
            console.log('æµ‹è¯•æœ€æ–°å•†å“æ¨é€å“åº”:', result);

            if (result.success) {
                showToast(result.message, 'success');
            } else {
                showToast(result.message, 'error');
                console.error('æµ‹è¯•æœ€æ–°å•†å“æ¨é€å¤±è´¥:', result.message);
            }
        } catch (error) {
            showToast('æµ‹è¯•æœ€æ–°å•†å“æ¨é€å¤±è´¥', 'error');
            console.error('æµ‹è¯•æœ€æ–°å•†å“æ¨é€å¼‚å¸¸:', error);
        }
    }

    // ==================== äº§å“åŒ¹é…è§„åˆ™ç®¡ç† ====================
    let currentMatchRuleId = null;

    // åŠ è½½åŒ¹é…è§„åˆ™åˆ—è¡¨
    async function loadMatchRules() {
        try {
            const response = await fetch('/api/product-match-rules');
            const rules = await response.json();

            if (response.ok) {
                renderMatchRulesList(rules);
            } else {
                showToast('åŠ è½½åŒ¹é…è§„åˆ™å¤±è´¥: ' + rules.error, 'error');
            }
        } catch (error) {
            showToast('åŠ è½½åŒ¹é…è§„åˆ™å¤±è´¥', 'error');
        }
    }

    // æ¸²æŸ“åŒ¹é…è§„åˆ™åˆ—è¡¨
    function renderMatchRulesList(rules) {
        const container = document.getElementById('matchRulesList');

        if (rules.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="bi bi-funnel display-4 mb-3"></i>
                    <p>æš‚æ— åŒ¹é…è§„åˆ™</p>
                    <button class="btn btn-success btn-sm" onclick="showAddMatchRuleModal()">
                        <i class="bi bi-plus-circle me-1"></i> æ·»åŠ ç¬¬ä¸€ä¸ªåŒ¹é…è§„åˆ™
                    </button>
                </div>
            `;
            return;
        }

        const html = rules.map(rule => {
            const enabledBadge = rule.enabled ?
                '<span class="badge bg-success">å¯ç”¨</span>' :
                '<span class="badge bg-secondary">ç¦ç”¨</span>';

            const notificationConfigs = JSON.parse(rule.notification_configs || '[]');
            const notificationNames = notificationConfigs.length > 0 ?
                `${notificationConfigs.length} ä¸ªé€šçŸ¥æ¸ é“` : 'æœªé…ç½®é€šçŸ¥';

            return `
                <div class="card mb-3 ${rule.enabled ? 'border-success' : 'border-secondary'}">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <div class="d-flex align-items-center mb-2">
                                    <h6 class="card-title mb-0 me-3">${rule.rule_name}</h6>
                                    ${enabledBadge}
                                </div>
                                <p class="card-text text-muted small mb-2">${rule.description || 'æ— æè¿°'}</p>
                                <div class="row">
                                    <div class="col-md-6">
                                        <small class="text-muted">
                                            <strong>åŒ¹é…é€»è¾‘ï¼š</strong>${rule.match_logic}<br>
                                            <strong>é€šçŸ¥æ¸ é“ï¼š</strong>${notificationNames}<br>
                                            <strong>åˆ›å»ºæ—¶é—´ï¼š</strong>${rule.created_at}
                                        </small>
                                    </div>
                                    <div class="col-md-6">
                                        <small class="text-muted">
                                            ${rule.keywords_include ? `<strong>åŒ…å«å…³é”®è¯ï¼š</strong>${rule.keywords_include}<br>` : ''}
                                            ${rule.price_min || rule.price_max ? `<strong>ä»·æ ¼èŒƒå›´ï¼š</strong>Â¥${rule.price_min || 'ä¸é™'} - Â¥${rule.price_max || 'ä¸é™'}<br>` : ''}
                                            ${rule.locations_include ? `<strong>åœ°åŒºï¼š</strong>${rule.locations_include}` : ''}
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-primary" onclick="showEditMatchRuleModal(${rule.id})" title="ç¼–è¾‘">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm ${rule.enabled ? 'btn-outline-warning' : 'btn-outline-success'}"
                                            onclick="toggleMatchRule(${rule.id}, ${!rule.enabled})" title="${rule.enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}">
                                        <i class="bi ${rule.enabled ? 'bi-pause' : 'bi-play'}"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteMatchRule(${rule.id}, '${rule.rule_name}')" title="åˆ é™¤">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        container.innerHTML = html;
    }

    // æ˜¾ç¤ºæ·»åŠ åŒ¹é…è§„åˆ™æ¨¡æ€æ¡†
    function showAddMatchRuleModal() {
        currentMatchRuleId = null;
        document.getElementById('matchRuleModalTitle').textContent = 'æ·»åŠ åŒ¹é…è§„åˆ™';
        document.getElementById('matchRuleForm').reset();
        loadNotificationCheckboxes();
        const modal = new bootstrap.Modal(document.getElementById('matchRuleModal'));
        modal.show();
    }

    // æ˜¾ç¤ºç¼–è¾‘åŒ¹é…è§„åˆ™æ¨¡æ€æ¡†
    async function showEditMatchRuleModal(ruleId) {
        try {
            currentMatchRuleId = ruleId;
            document.getElementById('matchRuleModalTitle').textContent = 'ç¼–è¾‘åŒ¹é…è§„åˆ™';

            // è·å–è§„åˆ™è¯¦æƒ…
            const response = await fetch(`/api/product-match-rules/${ruleId}`);
            const rule = await response.json();

            if (!response.ok) {
                showToast('è·å–è§„åˆ™è¯¦æƒ…å¤±è´¥: ' + rule.message, 'error');
                return;
            }

            // å¡«å……è¡¨å•
            document.getElementById('ruleName').value = rule.rule_name;
            document.getElementById('matchLogic').value = rule.match_logic;
            document.getElementById('ruleDescription').value = rule.description || '';
            document.getElementById('keywordsInclude').value = rule.keywords_include || '';
            document.getElementById('keywordsExclude').value = rule.keywords_exclude || '';
            document.getElementById('priceMin').value = rule.price_min || '';
            document.getElementById('priceMax').value = rule.price_max || '';
            document.getElementById('locationsInclude').value = rule.locations_include || '';
            document.getElementById('locationsExclude').value = rule.locations_exclude || '';
            document.getElementById('sellerCreditMin').value = rule.seller_credit_min || '';
            document.getElementById('ruleEnabled').checked = rule.enabled;

            // åŠ è½½é€šçŸ¥é…ç½®å¤é€‰æ¡†
            await loadNotificationCheckboxes(JSON.parse(rule.notification_configs || '[]'));

            const modal = new bootstrap.Modal(document.getElementById('matchRuleModal'));
            modal.show();

        } catch (error) {
            showToast('è·å–è§„åˆ™è¯¦æƒ…å¤±è´¥', 'error');
        }
    }

    // åŠ è½½é€šçŸ¥é…ç½®å¤é€‰æ¡†
    async function loadNotificationCheckboxes(selectedConfigs = []) {
        try {
            const response = await fetch('/api/notification-configs');
            const configs = await response.json();

            const container = document.getElementById('notificationCheckboxList');

            if (configs.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        æš‚æ— é€šçŸ¥é…ç½®ï¼Œè¯·å…ˆæ·»åŠ é€šçŸ¥é…ç½®
                    </div>
                `;
                return;
            }

            const html = configs.map(config => `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="${config.id}"
                           id="notification_${config.id}"
                           ${selectedConfigs.includes(config.id) ? 'checked' : ''}>
                    <label class="form-check-label" for="notification_${config.id}">
                        <i class="bi bi-${getPlatformIcon(config.platform)} me-1"></i>
                        ${config.config_name} (${config.platform})
                        ${config.enabled ? '<span class="badge bg-success ms-1">å¯ç”¨</span>' : '<span class="badge bg-secondary ms-1">ç¦ç”¨</span>'}
                    </label>
                </div>
            `).join('');

            container.innerHTML = html;

        } catch (error) {
            document.getElementById('notificationCheckboxList').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    åŠ è½½é€šçŸ¥é…ç½®å¤±è´¥
                </div>
            `;
        }
    }

    // è·å–å¹³å°å›¾æ ‡
    function getPlatformIcon(platform) {
        const icons = {
            'dingtalk': 'bell',
            'feishu': 'chat-dots',
            'wechat_work': 'wechat',
            'email': 'envelope'
        };
        return icons[platform] || 'gear';
    }

    // ä¿å­˜åŒ¹é…è§„åˆ™
    async function saveMatchRule() {
        const form = document.getElementById('matchRuleForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        // è·å–é€‰ä¸­çš„é€šçŸ¥é…ç½®
        const selectedNotifications = [];
        document.querySelectorAll('#notificationCheckboxList input:checked').forEach(checkbox => {
            selectedNotifications.push(parseInt(checkbox.value));
        });

        const data = {
            rule_name: document.getElementById('ruleName').value,
            enabled: document.getElementById('ruleEnabled').checked,
            match_logic: document.getElementById('matchLogic').value,
            description: document.getElementById('ruleDescription').value,
            keywords_include: document.getElementById('keywordsInclude').value,
            keywords_exclude: document.getElementById('keywordsExclude').value,
            price_min: document.getElementById('priceMin').value ? parseFloat(document.getElementById('priceMin').value) : null,
            price_max: document.getElementById('priceMax').value ? parseFloat(document.getElementById('priceMax').value) : null,
            locations_include: document.getElementById('locationsInclude').value,
            locations_exclude: document.getElementById('locationsExclude').value,
            seller_credit_min: document.getElementById('sellerCreditMin').value,
            notification_configs: selectedNotifications
        };

        try {
            const isEdit = currentMatchRuleId !== null;
            const url = isEdit ? `/api/product-match-rules/${currentMatchRuleId}` : '/api/product-match-rules';
            const method = isEdit ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                showToast(result.message, 'success');
                bootstrap.Modal.getInstance(document.getElementById('matchRuleModal')).hide();
                loadMatchRules();
            } else {
                showToast(result.message, 'error');
            }
        } catch (error) {
            showToast('ä¿å­˜åŒ¹é…è§„åˆ™å¤±è´¥', 'error');
        }
    }

    // åˆ‡æ¢åŒ¹é…è§„åˆ™å¯ç”¨çŠ¶æ€
    async function toggleMatchRule(ruleId, enabled) {
        try {
            const response = await fetch(`/api/product-match-rules/${ruleId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ enabled: enabled })
            });

            const result = await response.json();

            if (result.success) {
                showToast(result.message, 'success');
                loadMatchRules();
            } else {
                showToast(result.message, 'error');
            }
        } catch (error) {
            showToast('æ“ä½œå¤±è´¥', 'error');
        }
    }

    // åˆ é™¤åŒ¹é…è§„åˆ™
    async function deleteMatchRule(ruleId, ruleName) {
        if (!confirm(`ç¡®å®šè¦åˆ é™¤åŒ¹é…è§„åˆ™ "${ruleName}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
            return;
        }

        try {
            const response = await fetch(`/api/product-match-rules/${ruleId}`, {
                method: 'DELETE'
            });

            const result = await response.json();

            if (result.success) {
                showToast(result.message, 'success');
                loadMatchRules();
            } else {
                showToast(result.message, 'error');
            }
        } catch (error) {
            showToast('åˆ é™¤åŒ¹é…è§„åˆ™å¤±è´¥', 'error');
        }
    }

    // æœ€æ–°å‘å¸ƒå•†å“æ¨é€å·²ç®€åŒ–ï¼Œæ— éœ€é¢å¤–é…ç½®æ§ä»¶

// é¡µé¢åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        console.log('é¡µé¢DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');

        // æ£€æŸ¥æ‰€æœ‰çŠ¶æ€
        checkSystemStatus();
        setInterval(checkSystemStatus, 30000); // æ¯30ç§’åˆ·æ–°çŠ¶æ€
        checkSpiderStatus();
        checkServerStatus();
        checkCookieStatus();
        loadDatabaseStats();
        refreshScrapingStats();

        // ç³»ç»Ÿæ—¥å¿—è‡ªåŠ¨åŠ è½½ä¿éšœæœºåˆ¶
        console.log('é¡µé¢åˆå§‹åŒ–ï¼šæ£€æŸ¥ç³»ç»Ÿæ—¥å¿—åŠ è½½çŠ¶æ€...');

        // æ£€æŸ¥ç³»ç»Ÿæ—¥å¿—æ˜¯å¦å·²åŠ è½½ï¼Œå¦‚æœæ²¡æœ‰åˆ™å¼ºåˆ¶åŠ è½½
        setTimeout(() => {
            const logContainer = document.getElementById('logContainer');
            if (logContainer) {
                const hasLoadingText = logContainer.innerHTML.includes('æ­£åœ¨åŠ è½½ç³»ç»Ÿæ—¥å¿—') ||
                                      logContainer.innerHTML.includes('hourglass-split') ||
                                      logContainer.textContent.trim() === '';

                if (hasLoadingText) {
                    console.log('ğŸš¨ DOMContentLoadedæ£€æµ‹åˆ°ç³»ç»Ÿæ—¥å¿—æœªåŠ è½½ï¼Œå¼ºåˆ¶åŠ è½½...');
                    try {
                        if (typeof generateSystemLogs === 'function' &&
                            typeof displayLogs === 'function' &&
                            typeof updateLogCount === 'function') {

                            if (typeof systemLogs === 'undefined') {
                                window.systemLogs = [];
                            }

                            systemLogs = generateSystemLogs();
                            displayLogs();
                            updateLogCount();
                            console.log('âœ… DOMContentLoadedå¼ºåˆ¶åŠ è½½ç³»ç»Ÿæ—¥å¿—æˆåŠŸ');
                        } else {
                            console.error('âŒ ç³»ç»Ÿæ—¥å¿—å‡½æ•°æœªå®šä¹‰ï¼Œæ— æ³•å¼ºåˆ¶åŠ è½½');
                        }
                    } catch (error) {
                        console.error('âŒ DOMContentLoadedå¼ºåˆ¶åŠ è½½ç³»ç»Ÿæ—¥å¿—å¤±è´¥:', error);
                    }
                } else {
                    console.log('âœ… ç³»ç»Ÿæ—¥å¿—å·²æ­£å¸¸åŠ è½½');
                }
            } else {
                console.log('âš ï¸ logContainerå…ƒç´ ä¸å­˜åœ¨');
            }
        }, 1000);

        // å»¶è¿ŸåŠ è½½é€šçŸ¥é…ç½®ï¼Œç¡®ä¿DOMå®Œå…¨å‡†å¤‡å¥½
        setTimeout(() => {
            console.log('å¼€å§‹åŠ è½½é€šçŸ¥é…ç½®...');
            loadNotificationConfigs();
        }, 500);

        // å†æ¬¡å»¶è¿Ÿå¼ºåˆ¶åˆ·æ–°é€šçŸ¥é…ç½®
        setTimeout(() => {
            console.log('å¼ºåˆ¶åˆ·æ–°é€šçŸ¥é…ç½®...');
            loadNotificationConfigs();
        }, 2000);

        // ç¬¬ä¸‰é‡ä¿éšœï¼š5ç§’åå†æ¬¡æ£€æŸ¥
        setTimeout(() => {
            console.log('ç¬¬ä¸‰æ¬¡æ£€æŸ¥é€šçŸ¥é…ç½®åŠ è½½çŠ¶æ€...');
            const container = document.getElementById('notificationConfigsList');
            if (container && container.textContent.includes('æ­£åœ¨åŠ è½½é€šçŸ¥é…ç½®')) {
                console.log('ç¬¬ä¸‰æ¬¡æ£€æµ‹åˆ°æœªåŠ è½½ï¼Œå¼ºåˆ¶è§¦å‘...');
                loadNotificationConfigs();
            }
        }, 5000);

        // åŠ è½½äº§å“åŒ¹é…è§„åˆ™
        setTimeout(() => {
            loadMatchRules();
        }, 1000);

        
        // ç»‘å®šCookieè¾“å…¥äº‹ä»¶
        const cookieInput = document.getElementById('cookieInput');
        if (cookieInput) {
            cookieInput.addEventListener('input', updateCharCount);
            cookieInput.addEventListener('paste', () => {
                setTimeout(updateCharCount, 100); // ç­‰å¾…ç²˜è´´å®Œæˆ
            });
        }

        // åˆå§‹åŒ–å­—ç¬¦è®¡æ•°
        updateCharCount();

        // ç»‘å®šè‡ªåŠ¨åˆ·æ–°å¼€å…³äº‹ä»¶
        const autoRefresh = document.getElementById('autoRefresh');
        if (autoRefresh) {
            autoRefresh.addEventListener('change', toggleAutoRefresh);
        }

        // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
        startAutoRefresh();

        // æ·»åŠ ç¤ºä¾‹æ—¥å¿—
        setTimeout(() => {
            addLog('info', 'ç³»ç»Ÿè®¾ç½®é¡µé¢åŠ è½½å®Œæˆ', 'æ‰€æœ‰åŠŸèƒ½æ¨¡å—å·²åˆå§‹åŒ–');
        }, 1000);

        // ç«‹å³å¼ºåˆ¶è§¦å‘ä¸€æ¬¡é€šçŸ¥é…ç½®åŠ è½½ï¼ˆä¸ä¾èµ–ä»»ä½•å»¶è¿Ÿï¼‰
        loadNotificationConfigs();

        // 10ç§’åå†æ¬¡æ£€æŸ¥é€šçŸ¥é…ç½®åŠ è½½
        setTimeout(() => {
            const container = document.getElementById('notificationConfigsList');
            if (container && container.textContent.includes('æ­£åœ¨åŠ è½½é€šçŸ¥é…ç½®')) {
                console.log('æ£€æµ‹åˆ°é€šçŸ¥é…ç½®ä»æœªåŠ è½½ï¼Œå¼ºåˆ¶é‡æ–°åŠ è½½...');
                forceRefreshNotifications();
            }
        }, 10000);

        // åŠ è½½ä½“éªŒè´¦æˆ·çŠ¶æ€ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
        {% if session.role == 'admin' %}
        console.log('å½“å‰ç”¨æˆ·æ˜¯ç®¡ç†å‘˜ï¼Œå‡†å¤‡åŠ è½½ä½“éªŒè´¦æˆ·çŠ¶æ€...');
        setTimeout(() => {
            console.log('å¼€å§‹è°ƒç”¨ loadTrialUsersStatus()');
            loadTrialUsersStatus();
        }, 1000);

        // æ¯30ç§’åˆ·æ–°ä½“éªŒè´¦æˆ·çŠ¶æ€
        setInterval(() => {
            loadTrialUsersStatus();
        }, 30000);
        {% endif %}
    });

    // ==================== ä½“éªŒè´¦æˆ·ç®¡ç†åŠŸèƒ½ï¼ˆä»…ç®¡ç†å‘˜ï¼‰====================
    {% if session.role == 'admin' %}

    // å»¶é•¿ä½“éªŒè´¦æˆ·æ—¶é—´
    async function extendTrial() {
        const username = document.getElementById('trialUsername').value.trim();
        const minutes = parseInt(document.getElementById('extendMinutes').value) || 2;

        if (!username) {
            showToast('è¯·è¾“å…¥è¦å»¶æœŸçš„ä½“éªŒè´¦æˆ·ç”¨æˆ·å', 'warning');
            return;
        }

        if (!minutes || minutes < 1 || minutes > 1440) {
            showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„å»¶é•¿æ—¶é—´ï¼ˆ1-1440åˆ†é’Ÿï¼‰', 'warning');
            return;
        }

        try {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const statusDiv = document.getElementById('extendTrialStatus');
            statusDiv.innerHTML = `
                <div class="alert alert-info">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-2"></div>
                        <strong>æ­£åœ¨å»¶é•¿ä½“éªŒè´¦æˆ·æ—¶é—´...</strong>
                    </div>
                </div>
            `;

            const response = await fetch('/api/admin/extend-trial', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: username,
                    minutes: minutes
                })
            });

            const result = await response.json();

            if (result.success) {
                statusDiv.innerHTML = `
                    <div class="alert alert-success">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            <strong>${result.message}</strong>
                        </div>
                    </div>
                `;

                // æ¸…ç©ºè¡¨å•
                document.getElementById('extendTrialForm').reset();
                document.getElementById('extendMinutes').value = '2';

                // åˆ·æ–°ä½“éªŒè´¦æˆ·çŠ¶æ€
                loadTrialUsersStatus();

                showToast('ä½“éªŒè´¦æˆ·æ—¶é—´å»¶é•¿æˆåŠŸï¼', 'success');
            } else {
                statusDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-x-circle-fill me-2"></i>
                            <strong>å»¶é•¿å¤±è´¥ï¼š${result.message}</strong>
                        </div>
                    </div>
                `;

                showToast('å»¶é•¿ä½“éªŒè´¦æˆ·æ—¶é—´å¤±è´¥', 'error');
            }

        } catch (error) {
            console.error('å»¶é•¿ä½“éªŒè´¦æˆ·å¼‚å¸¸:', error);

            const statusDiv = document.getElementById('extendTrialStatus');
            statusDiv.innerHTML = `
                <div class="alert alert-warning">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <strong>æ“ä½œå¤±è´¥ï¼šç½‘ç»œè¿æ¥å¼‚å¸¸</strong>
                    </div>
                </div>
            `;

            showToast('å»¶é•¿ä½“éªŒè´¦æˆ·æ—¶é—´å¤±è´¥ï¼šç½‘ç»œè¿æ¥å¼‚å¸¸', 'warning');
        }
    }

    // åŠ è½½ä½“éªŒè´¦æˆ·çŠ¶æ€
    async function loadTrialUsersStatus() {
        console.log('å¼€å§‹åŠ è½½ä½“éªŒè´¦æˆ·çŠ¶æ€...');
        try {
            const response = await fetch('/api/admin/trial-users-status');
            console.log('APIå“åº”çŠ¶æ€:', response.status);

            if (!response.ok) {
                if (response.status === 401) {
                    throw new Error('è¯·å…ˆç™»å½•');
                } else if (response.status === 403) {
                    throw new Error('æƒé™ä¸è¶³ï¼Œéœ€è¦ç®¡ç†å‘˜æƒé™');
                } else {
                    throw new Error('è·å–ä½“éªŒè´¦æˆ·çŠ¶æ€å¤±è´¥');
                }
            }

            const result = await response.json();
            console.log('APIå“åº”ç»“æœ:', result);

            if (result.success) {
                renderTrialUsersList(result.users);
            } else {
                throw new Error(result.message || result.error || 'è·å–çŠ¶æ€å¤±è´¥');
            }

        } catch (error) {
            console.error('åŠ è½½ä½“éªŒè´¦æˆ·çŠ¶æ€å¼‚å¸¸:', error);

            const tbody = document.getElementById('trialUsersList');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            åŠ è½½å¤±è´¥ï¼š${error.message}
                        </td>
                    </tr>
                `;
            }
        }
    }

    // æ¸²æŸ“ä½“éªŒè´¦æˆ·åˆ—è¡¨
    function renderTrialUsersList(users) {
        const tbody = document.getElementById('trialUsersList');

        if (!users || users.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-muted">
                        <i class="bi bi-inbox me-2"></i>
                        æš‚æ— ä½“éªŒè´¦æˆ·
                    </td>
                </tr>
            `;
            return;
        }

        const html = users.map(user => {
            const roleBadge = user.role === 'trial'
                ? '<span class="badge bg-info">ä½“éªŒ</span>'
                : user.role === 'admin'
                ? '<span class="badge bg-warning text-dark">ç®¡ç†å‘˜</span>'
                : '<span class="badge bg-secondary">æ™®é€š</span>';

            // å¤„ç†æ—¥æœŸå­—ç¬¦ä¸²ï¼Œå°†å…¶è½¬æ¢ä¸ºDateå¯¹è±¡
            const expiresAt = user.trial_expires_at ? new Date(user.trial_expires_at) : null;

            // æ£€æŸ¥æš‚åœçŠ¶æ€
            const isPaused = user.paused === 1;
            const pauseBadge = isPaused
                ? '<span class="badge bg-warning text-dark"><i class="bi bi-pause-fill"></i> å·²æš‚åœ</span>'
                : '';

            const statusBadge = user.trial_expired
                ? '<span class="badge bg-danger">å·²è¿‡æœŸ</span>'
                : expiresAt && expiresAt > new Date()
                ? `<span class="badge bg-success">æ­£å¸¸</span>`
                : '<span class="badge bg-warning text-dark">å³å°†è¿‡æœŸ</span>';

            const remainingTime = isPaused
                ? `${user.paused_remaining_minutes || 0}åˆ†é’Ÿ (å·²æš‚åœ)`
                : expiresAt && expiresAt > new Date()
                ? formatRemainingTime(expiresAt)
                : 'å·²è¿‡æœŸ';

            return `
                <tr>
                    <td>${user.username}</td>
                    <td>${roleBadge}</td>
                    <td>${remainingTime}</td>
                    <td>${statusBadge} ${pauseBadge}</td>
                    <td>
                        ${user.role === 'trial' ? `
                            ${isPaused ? `
                            <button class="btn btn-sm btn-success" onclick="resumeTrial('${user.username}')" title="æ¢å¤ä½“éªŒè´¦æˆ·">
                                <i class="bi bi-play-fill"></i> æ¢å¤
                            </button>
                            ` : `
                            <button class="btn btn-sm btn-warning" onclick="pauseTrial('${user.username}')" title="æš‚åœä½“éªŒè´¦æˆ·">
                                <i class="bi bi-pause-fill"></i> æš‚åœ
                            </button>
                            `}
                            ${user.trial_expired ? `
                            <button class="btn btn-sm btn-success" onclick="quickExtendTrial('${user.username}')" title="å¿«é€Ÿå»¶é•¿2åˆ†é’Ÿ">
                                <i class="bi bi-arrow-clockwise"></i> å¿«é€Ÿå»¶æœŸ
                            </button>
                            ` : ''}
                        ` : ''}
                    </td>
                </tr>
            `;
        }).join('');

        tbody.innerHTML = html;
    }

    // å¿«é€Ÿå»¶é•¿ä½“éªŒè´¦æˆ·ï¼ˆé»˜è®¤2åˆ†é’Ÿï¼‰
    function quickExtendTrial(username) {
        document.getElementById('trialUsername').value = username;
        document.getElementById('extendMinutes').value = '2';
        extendTrial();
    }

    // æš‚åœä½“éªŒè´¦æˆ·
    async function pauseTrial(username) {
        if (!confirm(`ç¡®å®šè¦æš‚åœç”¨æˆ· ${username} çš„ä½“éªŒè´¦æˆ·å—ï¼Ÿ\næš‚åœåå€’è®¡æ—¶å°†åœæ­¢ï¼Œè´¦æˆ·ç™»å½•åè‡ªåŠ¨æ¢å¤ã€‚`)) {
            return;
        }

        try {
            const response = await fetch('/api/admin/pause-trial', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username: username })
            });

            const result = await response.json();

            if (result.success) {
                showToast('success', result.message || 'ä½“éªŒè´¦æˆ·å·²æš‚åœ');
                // åˆ·æ–°ä½“éªŒè´¦æˆ·çŠ¶æ€
                setTimeout(() => {
                    refreshScrapingStats();
                }, 500);
            } else {
                showToast('error', result.message || 'æš‚åœå¤±è´¥');
            }

        } catch (error) {
            console.error('æš‚åœä½“éªŒè´¦æˆ·å¼‚å¸¸:', error);
            showToast('error', 'æš‚åœå¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    }

    // æ¢å¤ä½“éªŒè´¦æˆ·
    async function resumeTrial(username) {
        if (!confirm(`ç¡®å®šè¦æ¢å¤ç”¨æˆ· ${username} çš„ä½“éªŒè´¦æˆ·å—ï¼Ÿ`)) {
            return;
        }

        try {
            const response = await fetch('/api/admin/resume-trial', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username: username })
            });

            const result = await response.json();

            if (result.success) {
                showToast('success', result.message || 'ä½“éªŒè´¦æˆ·å·²æ¢å¤');
                // åˆ·æ–°ä½“éªŒè´¦æˆ·çŠ¶æ€
                setTimeout(() => {
                    refreshScrapingStats();
                }, 500);
            } else {
                showToast('error', result.message || 'æ¢å¤å¤±è´¥');
            }

        } catch (error) {
            console.error('æ¢å¤ä½“éªŒè´¦æˆ·å¼‚å¸¸:', error);
            showToast('error', 'æ¢å¤å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    }

    // æ ¼å¼åŒ–å‰©ä½™æ—¶é—´
    function formatRemainingTime(expiresAt) {
        const now = new Date();
        const diff = expiresAt - now;

        if (diff <= 0) {
            return 'å·²è¿‡æœŸ';
        }

        const minutes = Math.floor(diff / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);

        if (minutes > 60) {
            const hours = Math.floor(minutes / 60);
            const remainingMinutes = minutes % 60;
            return `${hours}å°æ—¶${remainingMinutes}åˆ†é’Ÿ`;
        } else if (minutes > 0) {
            return `${minutes}åˆ†é’Ÿ${seconds}ç§’`;
        } else {
            return `${seconds}ç§’`;
        }
    }

    {% endif %}
</script>
{% endblock %}