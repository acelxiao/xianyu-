{% extends "base.html" %}

{% block title %}æ•°æ®çˆ¬å– - é—²é±¼æ•°æ®ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<style>
    /* è‡ªå®šä¹‰æ ·å¼å¢å¼º */
    .stat-item {
        transition: all 0.3s ease;
        border: 1px solid transparent !important;
    }

    .stat-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border-color: #dee2e6 !important;
    }

    .btn-light:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .card {
        transition: all 0.3s ease;
    }

    .card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .h5 {
        transition: all 0.2s ease;
    }

    #statusBadge {
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }

    /* åœæ­¢æŒ‰é’®è„‰å†²åŠ¨ç”» */
    .pulse-animation {
        animation: stopBtnPulse 1.5s infinite;
        box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
        transition: all 0.3s ease;
    }

    .pulse-animation:hover {
        animation: none;
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
        transform: translateY(-2px);
    }

    @keyframes stopBtnPulse {
        0% {
            box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
        }
    }

    /* åœæ­¢æŒ‰é’®ç¦ç”¨çŠ¶æ€æ ·å¼ */
    .pulse-animation:disabled {
        animation: none;
        opacity: 0.6;
        box-shadow: none;
        transform: none;
    }

    .btn-text {
        transition: all 0.2s ease;
    }

    .btn:hover .btn-text {
        transform: translateX(2px);
    }

    /* ç®€æ´çš„ç³»ç»ŸçŠ¶æ€å¡ç‰‡æ ·å¼ */
    .stat-item {
        transition: all 0.2s ease;
    }

    .stat-item:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
</style>

<div class="container-fluid">
    <!-- çˆ¬å–å»ºè®® - ç‹¬ç«‹ç¬¬ä¸€æ’ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                <h6 class="alert-heading">
                    <i class="bi bi-lightbulb"></i> <strong>çˆ¬å–å»ºè®®</strong>
                </h6>
                <div class="row">
                    <div class="col-md-4">
                        <strong>ğŸ• å»¶è¿Ÿç­–ç•¥ï¼š</strong>
                        <ul class="mb-0 small">
                            <li><strong>æ—¥å¸¸ä½¿ç”¨</strong>ï¼šæ­£å¸¸(3ç§’)æˆ–ç¨³å¥(4ç§’)</li>
                            <li><strong>å¤§é‡çˆ¬å–</strong>ï¼šç¼“æ…¢(5ç§’)æˆ–å¾ˆæ…¢(8ç§’)</li>
                            <li><strong>é¿å…æ‹¦æˆª</strong>ï¼šå»ºè®®â‰¥3ç§’å»¶è¿Ÿ</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <strong>ğŸ“„ é¡µæ•°é€‰æ‹©ï¼š</strong>
                        <ul class="mb-0 small">
                            <li><strong>æµ‹è¯•éªŒè¯</strong>ï¼š1-2é¡µ</li>
                            <li><strong>å¸¸è§„æ”¶é›†</strong>ï¼š3-5é¡µ</li>
                            <li><strong>å¤§é‡æ•°æ®</strong>ï¼š5-10é¡µ</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <strong>ğŸ›¡ï¸ å®‰å…¨æç¤ºï¼š</strong>
                        <ul class="mb-0 small">
                            <li>çˆ¬å–é—´éš”â‰¥3ç§’é™ä½é£é™©</li>
                            <li>é¿å…çŸ­æ—¶é—´å†…å¤§é‡çˆ¬å–</li>
                            <li>å®šæœŸæ£€æŸ¥Cookieæœ‰æ•ˆæ€§</li>
                        </ul>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- ä¸»è¦çˆ¬å–åŒºåŸŸ -->
        <div class="col-lg-8">
            <!-- çˆ¬å–é…ç½®å¡ç‰‡ -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-gradient-primary text-white py-3">
                    <h5 class="mb-0">
                        <i class="bi bi-search"></i> <span style="color: #ff4757;">é—²é±¼æ•°æ®çˆ¬å–å·¥å…·</span>
                    </h5>
                </div>

                <div class="card-body p-4">
                    <form id="scrapeForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="keyword" class="form-label fw-bold">
                                        <i class="bi bi-tag text-primary"></i> æœç´¢å…³é”®è¯
                                    </label>
                                    <div class="input-group">
                                        <input type="text" class="form-control form-control-lg" id="keyword" name="keyword"
                                               value="æ‰‹æœº" required placeholder="è¾“å…¥å…³é”®è¯ï¼Œå¦‚ï¼šæ‰‹æœºã€ç›¸æœº">
                                        <button class="btn btn-outline-primary btn-lg" type="button"
                                                data-bs-toggle="tooltip" title="ä»å†å²ä¸­é€‰æ‹©" onclick="showKeywordHistory()">
                                            <i class="bi bi-clock-history"></i> å†å²
                                        </button>
                                    </div>
                                    <div class="form-text">è¾“å…¥æƒ³è¦çˆ¬å–çš„é—²é±¼å•†å“å…³é”®è¯</div>
                                </div>
                            </div>

                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="max_pages" class="form-label fw-bold">
                                        <i class="bi bi-file-text text-success"></i> çˆ¬å–é¡µæ•°
                                    </label>
                                    <select class="form-select form-select-lg" id="max_pages" name="max_pages">
                                        <option value="1">1é¡µ (çº¦25ä¸ª)</option>
                                        <option value="2">2é¡µ (çº¦50ä¸ª)</option>
                                        <option value="3" selected>3é¡µ (çº¦75ä¸ª)</option>
                                        <option value="5">5é¡µ (çº¦125ä¸ª)</option>
                                        <option value="10">10é¡µ (çº¦250ä¸ª)</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="delay" class="form-label fw-bold">
                                        <i class="bi bi-clock text-warning"></i> å»¶è¿Ÿæ—¶é—´
                                    </label>
                                    <select class="form-select form-select-lg" id="delay" name="delay">
                                        <option value="1">æå¿« (1ç§’)</option>
                                        <option value="2" selected>å¿«é€Ÿ (2ç§’)</option>
                                        <option value="3">æ­£å¸¸ (3ç§’)</option>
                                        <option value="4">ç¨³å¥ (4ç§’)</option>
                                        <option value="5">ç¼“æ…¢ (5ç§’)</option>
                                        <option value="8">å¾ˆæ…¢ (8ç§’)</option>
                                        <option value="10">ææ…¢ (10ç§’)</option>
                                    </select>
                                    <div class="form-text">é¿å…è¯·æ±‚è¿‡å¿«</div>
                                </div>
                            </div>
                        </div>

                        <!-- CookieçŠ¶æ€æé†’ -->
                        <div id="cookieAlert" class="alert alert-warning border-0" role="alert">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                <div>
                                    <strong>CookieçŠ¶æ€æ£€æŸ¥</strong>
                                    <div class="small">æ­£åœ¨æ£€æŸ¥Cookieæœ‰æ•ˆæ€§...</div>
                                </div>
                                <button class="btn btn-sm btn-outline-primary ms-auto" onclick="checkCookieStatus()">
                                    åˆ·æ–°çŠ¶æ€
                                </button>
                            </div>
                        </div>

                        <!-- ç³»ç»Ÿæ£€æŸ¥ -->
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <div class="d-grid">
                                    <button type="button" class="btn btn-outline-info" onclick="testConnection()">
                                        <i class="bi bi-wifi"></i> æµ‹è¯•è¿æ¥
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-grid">
                                    <button type="button" class="btn btn-outline-secondary" onclick="previewKeyword()">
                                        <i class="bi bi-eye"></i> é¢„è§ˆå…³é”®è¯
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary btn-lg" id="scrapeBtn">
                                        <i class="bi bi-play-circle"></i> å¼€å§‹çˆ¬å–
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- è¿›åº¦ç›‘æ§åŒºåŸŸ -->
            <div id="progressArea" class="card shadow-sm" style="display: none;">
                <div class="card-header bg-info text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-activity"></i> çˆ¬å–è¿›åº¦ç›‘æ§
                        </h6>
                        <button class="btn btn-danger btn-lg pulse-animation" id="stopScrapeBtn" onclick="stopScraping()">
                            <i class="bi bi-stop-circle-fill me-1"></i>
                            <span class="fw-bold">åœæ­¢çˆ¬å–</span>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- ä¸»è¦è¿›åº¦æ¡ -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="fw-bold">æ€»ä½“è¿›åº¦</span>
                            <span id="progressPercentage">0%</span>
                        </div>
                        <div class="progress progress-lg">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                                 id="mainProgressBar" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- è¯¦ç»†çŠ¶æ€ -->
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card bg-light">
                                <div class="card-body py-2">
                                    <div class="d-flex align-items-center">
                                        <div class="spinner-border spinner-border-sm text-primary me-2"
                                             id="statusSpinner" role="status"></div>
                                        <span id="statusText" class="fw-bold">æ­£åœ¨åˆå§‹åŒ–...</span>
                                    </div>
                                    <div id="detailText" class="small text-muted mt-1">å‡†å¤‡å¼€å§‹çˆ¬å–</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <div class="row g-2">
                                    <div class="col-6">
                                        <div class="card bg-success text-white">
                                            <div class="card-body py-2">
                                                <div id="foundCount" class="h5 mb-0">0</div>
                                                <div class="small">å·²å‘ç°</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="card bg-info text-white">
                                            <div class="card-body py-2">
                                                <div id="savedCount" class="h5 mb-0">0</div>
                                                <div class="small">å·²ä¿å­˜</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ—¥å¿—è¾“å‡º -->
                    <div class="mt-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="fw-bold">å®æ—¶æ—¥å¿—</span>
                            <button class="btn btn-sm btn-outline-secondary" onclick="clearLogs()">
                                æ¸…ç©ºæ—¥å¿—
                            </button>
                        </div>
                        <div id="logOutput" class="bg-dark text-light p-3 rounded"
                             style="height: 150px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 14px;">
                            <div class="text-muted">ç­‰å¾…çˆ¬å–å¼€å§‹...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
            <div id="resultArea" class="mt-4" style="display: none;">
                <!-- åŠ¨æ€ç»“æœå†…å®¹ -->
            </div>
        </div>

        <!-- å³ä¾§ä¿¡æ¯é¢æ¿ -->
        <div class="col-lg-4">
            <!-- ç³»ç»ŸçŠ¶æ€å¡ç‰‡ -->
            <div class="card shadow-sm mb-4 border-0" style="background-color: #2c3e50;">
                <div class="card-header text-white border-0 bg-dark bg-opacity-50">
                    <h5 class="mb-0 d-flex align-items-center">
                        <i class="bi bi-activity me-2" style="font-size: 1.2rem;"></i>
                        <strong>ç³»ç»ŸçŠ¶æ€ç›‘æ§</strong>
                        <span class="ms-auto badge bg-success text-white fw-bold" id="statusBadge">
                            <i class="bi bi-broadcast me-1"></i>
                            å®æ—¶
                        </span>
                    </h5>
                </div>
                <div class="card-body bg-white">
                    <!-- ç»Ÿè®¡æ•°æ®ç½‘æ ¼ -->
                    <div class="row g-3 mb-4">
                        <div class="col-12">
                            <div class="stat-item text-center p-4 rounded-3 bg-light border border-primary border-opacity-25">
                                <div class="d-flex align-items-center justify-content-center mb-3">
                                    <i class="bi bi-database-fill text-primary me-3" style="font-size: 1.8rem;"></i>
                                    <div id="productStats" class="h4 mb-0 text-primary fw-bold">-</div>
                                </div>
                                <div class="text-dark fw-bold fs-6">å•†å“ç»Ÿè®¡</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-item text-center p-3 rounded-3 bg-light border border-info border-opacity-25">
                                <div class="d-flex align-items-center justify-content-center mb-2">
                                    <i class="bi bi-currency-yen text-info me-2" style="font-size: 1.4rem;"></i>
                                    <div id="avgPrice" class="h5 mb-0 text-info fw-bold">-</div>
                                </div>
                                <div class="text-dark fw-semibold">å¹³å‡ä»·æ ¼</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-item text-center p-3 rounded-3 bg-light border border-warning border-opacity-25">
                                <div class="d-flex align-items-center justify-content-center mb-2">
                                    <i class="bi bi-tags-fill text-warning me-2" style="font-size: 1.4rem;"></i>
                                    <div id="keywordCount" class="h5 mb-0 text-warning fw-bold">-</div>
                                </div>
                                <div class="text-dark fw-semibold">å…³é”®è¯æ•°</div>
                            </div>
                        </div>
                    </div>

                    <!-- åˆ†éš”çº¿ -->
                    <div class="border-top border-2 border-dark border-opacity-10 my-4"></div>

                    <!-- æ“ä½œæŒ‰é’® -->
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary btn-sm fw-bold py-2" onclick="refreshStats()">
                            <i class="bi bi-arrow-clockwise me-2"></i>
                            <span class="btn-text">åˆ·æ–°ç»Ÿè®¡</span>
                        </button>
                        <a href="{{ url_for('stats') }}" class="btn btn-outline-primary btn-sm fw-bold py-2">
                            <i class="bi bi-bar-chart me-2"></i>
                            <span class="btn-text">è¯¦ç»†ç»Ÿè®¡</span>
                        </a>
                    </div>
                </div>
            </div>

            <!-- å¿«é€Ÿæ“ä½œå¡ç‰‡ -->
            <div class="card shadow-sm mb-4 border-0" style="background-color: #f8f9fa;">
                <div class="card-header border-0">
                    <h6 class="mb-0 text-dark d-flex align-items-center">
                        <i class="bi bi-lightning-charge-fill text-warning me-2"></i>
                        å¿«é€Ÿå¯¼èˆª
                    </h6>
                </div>
                <div class="card-body bg-white bg-opacity-90">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('index') }}" class="btn btn-light btn-sm" style="border: 1px solid #e0e0e0; transition: all 0.2s;">
                            <i class="bi bi-grid-3x3-gap-fill text-primary me-1"></i>
                            <span class="btn-text">å•†å“åˆ—è¡¨</span>
                        </a>
                        <a href="{{ url_for('stats') }}" class="btn btn-light btn-sm" style="border: 1px solid #e0e0e0; transition: all 0.2s;">
                            <i class="bi bi-graph-up text-success me-1"></i>
                            <span class="btn-text">æ•°æ®ç»Ÿè®¡</span>
                        </a>
                        <a href="{{ url_for('system_settings') }}" class="btn btn-light btn-sm" style="border: 1px solid #e0e0e0; transition: all 0.2s;">
                            <i class="bi bi-sliders text-secondary me-1"></i>
                            <span class="btn-text">ç³»ç»Ÿè®¾ç½®</span>
                        </a>
                    </div>
                </div>
            </div>
</div>

<!-- å…³é”®è¯å†å²æ¨¡æ€æ¡† -->
<div class="modal fade" id="keywordHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-clock-history"></i> å…³é”®è¯å†å²è®°å½•
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                
                <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                <div class="alert alert-info mb-3 text-center">
                    <strong><i class="bi bi-clock-history"></i> å†å²å…³é”®è¯æ•°é‡ï¼š</strong>
                    <span id="totalHistoryCount">0</span> æ¡
                </div>

                <!-- å…³é”®è¯åˆ—è¡¨ -->
                <div id="keywordHistoryList" style="max-height: 400px; overflow-y: auto;">
                    <!-- åŠ¨æ€åŠ è½½å†å²å…³é”®è¯ -->
                </div>

                <!-- å¿«é€Ÿæ“ä½œ -->
                <div class="mt-3 pt-3 border-top text-center">
                    <button class="btn btn-sm btn-warning" onclick="clearAllHistory()">
                        <i class="bi bi-trash3"></i> æ¸…ç©ºå†å²
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <div class="row w-100">
                    <div class="col-md-6">
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i>
                            æç¤ºï¼šç‚¹å‡»å…³é”®è¯å¯é€‰æ‹©å¹¶å¡«å…¥è¡¨å•ï¼Œæ”¯æŒæ‰¹é‡æ“ä½œå’Œæœç´¢ç­›é€‰
                        </small>
                    </div>
                    <div class="col-md-6 text-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                        <button type="button" class="btn btn-primary" onclick="confirmKeywordSelection()">
                            <i class="bi bi-check-circle"></i> ç¡®è®¤é€‰æ‹©
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.space-y-2 > * + * {
    margin-top: 0.5rem;
}

/* å…³é”®è¯å†å²ç›¸å…³æ ·å¼ */
.keyword-item.selected .card {
    border: 2px solid #0d6efd !important;
    background-color: #f8f9fa;
}

.keyword-item {
    transition: all 0.3s ease;
}

.keyword-item:hover .card {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.keyword-checkbox {
    cursor: pointer;
}

.modal-lg {
    max-width: 900px;
}

/* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
#keywordHistoryList::-webkit-scrollbar {
    width: 8px;
}

#keywordHistoryList::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

#keywordHistoryList::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
}

#keywordHistoryList::-webkit-scrollbar-thumb:hover {
    background: #555;
}

/* æœç´¢æ¡†æ ·å¼ */
.input-group-text {
    background-color: #f8f9fa;
    border: 1px solid #ced4da;
}

/* æ’åºä¸‹æ‹‰èœå•æ ·å¼ */
.dropdown-menu {
    border: none;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.dropdown-item {
    transition: all 0.2s ease;
}

.dropdown-item:hover {
    background-color: #f8f9fa;
    transform: translateX(2px);
}

/* ç»Ÿè®¡ä¿¡æ¯æ ·å¼ */
.alert-info {
    background-color: #e3f2fd;
    border: none;
    border-radius: 10px;
}

/* æŒ‰é’®åŠ¨ç”» */
.btn {
    transition: all 0.2s ease;
}

.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* æ¨¡æ€æ¡†å¤´éƒ¨æ ·å¼ */
.modal-header {
    border-bottom: none;
    border-radius: 10px 10px 0 0;
}

/* æ¨¡æ€æ¡†åº•éƒ¨æ ·å¼ */
.modal-footer {
    border-top: 1px solid #e9ecef;
    background: #f8f9fa;
    border-radius: 0 0 10px 10px;
}
</style>
{% endblock %}

{% block scripts %}
<script>
    // å…¨å±€å˜é‡
    let isScraping = false;
    let logMessages = [];
    let currentScrapeController = null;

    // åœæ­¢çˆ¬è™«ä»»åŠ¡
    async function stopScraping() {
        if (!isScraping) {
            showToast('å½“å‰æ²¡æœ‰æ­£åœ¨è¿›è¡Œçš„çˆ¬å–ä»»åŠ¡', 'warning');
            return;
        }

        // ç¡®è®¤å¯¹è¯æ¡†
        if (!confirm('ç¡®å®šè¦åœæ­¢å½“å‰çš„çˆ¬å–ä»»åŠ¡å—ï¼Ÿå·²çˆ¬å–çš„æ•°æ®å¯èƒ½ä¼šä¸¢å¤±ã€‚')) {
            return;
        }

        try {
            // ç¦ç”¨åœæ­¢æŒ‰é’®
            const stopBtn = document.getElementById('stopScrapeBtn');
            stopBtn.disabled = true;
            stopBtn.className = 'btn btn-secondary btn-lg';
            stopBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> <span class="fw-bold">æ­£åœ¨åœæ­¢...</span>';

            // æ·»åŠ åœæ­¢æ—¥å¿—
            addLog('æ­£åœ¨åœæ­¢çˆ¬å–ä»»åŠ¡...', 'warning');

            // å¦‚æœæœ‰æ­£åœ¨è¿›è¡Œçš„fetchè¯·æ±‚ï¼Œå°è¯•å–æ¶ˆ
            if (currentScrapeController) {
                currentScrapeController.abort();
                currentScrapeController = null;
            }

            // å‘é€åœæ­¢è¯·æ±‚åˆ°åç«¯
            const response = await fetch('/api/stop-scraping', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();

            if (result.success) {
                addLog('çˆ¬å–ä»»åŠ¡å·²åœæ­¢', 'success');
                showToast('çˆ¬å–ä»»åŠ¡å·²åœæ­¢', 'success');

                // æ¨¡æ‹Ÿç­‰å¾…åç«¯å¤„ç†å®Œæˆ
                setTimeout(() => {
                    addLog('ç­‰å¾…çˆ¬è™«è¿›ç¨‹å®Œå…¨åœæ­¢...', 'info');
                }, 1000);
            } else {
                addLog('åœæ­¢çˆ¬å–æ—¶å‡ºç°é”™è¯¯: ' + result.message, 'error');
                showToast('åœæ­¢çˆ¬å–å¤±è´¥', 'error');
            }
        } catch (error) {
            addLog('åœæ­¢çˆ¬å–æ—¶å‡ºç°ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            showToast('åœæ­¢çˆ¬å–å¤±è´¥', 'error');
        } finally {
            // é‡ç½®çŠ¶æ€
            isScraping = false;
            setScrapingState(false);
            completeProgress('å·²åœæ­¢');

            // æ¢å¤åœæ­¢æŒ‰é’®
            const stopBtn = document.getElementById('stopScrapeBtn');
            stopBtn.disabled = false;
            stopBtn.className = 'btn btn-danger btn-lg pulse-animation';
            stopBtn.innerHTML = '<i class="bi bi-stop-circle-fill me-1"></i> <span class="fw-bold">åœæ­¢çˆ¬å–</span>';
        }
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        loadSystemStats();
        checkCookieStatus();
        loadKeywordHistory();

        // åˆå§‹åŒ–å·¥å…·æç¤º
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });

    // çˆ¬å–è¡¨å•æäº¤
    document.getElementById('scrapeForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        if (isScraping) {
            showToast('æ­£åœ¨çˆ¬å–ä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…...', 'warning');
            return;
        }

        const formData = new FormData(this);
        const keyword = formData.get('keyword').trim();
        const maxPages = formData.get('max_pages');

        if (!keyword) {
            showToast('è¯·è¾“å…¥æœç´¢å…³é”®è¯', 'warning');
            return;
        }

        // æ˜¾ç¤ºè¿›åº¦åŒºåŸŸ
        showProgressArea();

        // ç¦ç”¨æŒ‰é’®
        setScrapingState(true);

        // æ·»åŠ æ—¥å¿—
        addLog(`å¼€å§‹çˆ¬å–å…³é”®è¯: ${keyword}, é¡µæ•°: ${maxPages}`, 'info');
        addLog('æ­£åœ¨åˆå§‹åŒ–çˆ¬è™«å¼•æ“...', 'info');

        try {
            // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°
            simulateProgress();

            const response = await fetch('/scrape', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            // å®Œæˆè¿›åº¦
            completeProgress();

            if (result.success) {
                addLog(`çˆ¬å–æˆåŠŸ! ${result.message}`, 'success');
                showResult('success', result.message);

                // ä¿å­˜å…³é”®è¯åˆ°å†å²
                saveKeywordToHistory(keyword);

                // åˆ·æ–°ç»Ÿè®¡
                setTimeout(() => {
                    loadSystemStats();
                    loadRecentKeywords();
                }, 1000);
            } else {
                addLog(`çˆ¬å–å¤±è´¥: ${result.message}`, 'error');
                showResult('error', result.message);
            }

        } catch (error) {
            addLog(`è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            showResult('error', 'è¯·æ±‚å¤±è´¥: ' + error.message);
        }

        setScrapingState(false);
    });

    // æ˜¾ç¤ºè¿›åº¦åŒºåŸŸ
    function showProgressArea() {
        const progressArea = document.getElementById('progressArea');
        progressArea.style.display = 'block';
        resetProgress();

        // æ»šåŠ¨åˆ°è¿›åº¦åŒºåŸŸ
        progressArea.scrollIntoView({ behavior: 'smooth' });
    }

    // é‡ç½®è¿›åº¦
    function resetProgress() {
        document.getElementById('mainProgressBar').style.width = '0%';
        document.getElementById('progressPercentage').textContent = '0%';
        document.getElementById('statusText').textContent = 'æ­£åœ¨åˆå§‹åŒ–...';
        document.getElementById('detailText').textContent = 'å‡†å¤‡å¼€å§‹çˆ¬å–';
        document.getElementById('foundCount').textContent = '0';
        document.getElementById('savedCount').textContent = '0';
        document.getElementById('logOutput').innerHTML = '<div class="text-muted">ç­‰å¾…çˆ¬å–å¼€å§‹...</div>';
        logMessages = [];
    }

    // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°
    function simulateProgress() {
        let progress = 0;
        let page = 1;
        const maxPages = parseInt(document.getElementById('max_pages').value);

        const progressInterval = setInterval(() => {
            if (progress >= 100 || !isScraping) {
                clearInterval(progressInterval);
                return;
            }

            progress += Math.random() * 8;
            if (progress > 95) progress = 95;

            updateProgress(progress);

            // æ ¹æ®è¿›åº¦æ›´æ–°çŠ¶æ€
            if (progress < 20) {
                updateStatus('æ­£åœ¨å¯åŠ¨æµè§ˆå™¨...', 'åŠ è½½æµè§ˆå™¨ç»„ä»¶å’Œé…ç½®');
            } else if (progress < 40) {
                updateStatus('æ­£åœ¨åº”ç”¨Cookieè®¤è¯...', 'è®¾ç½®ç”¨æˆ·è®¤è¯ä¿¡æ¯');
            } else if (progress < 60) {
                const currentPage = Math.floor((progress - 40) / 20 * maxPages) + 1;
                updateStatus(`æ­£åœ¨æœç´¢å•†å“...`, `ç¬¬ ${currentPage} é¡µæ•°æ®è·å–ä¸­`);
                document.getElementById('foundCount').textContent = Math.floor(Math.random() * 20 + 5);
            } else if (progress < 80) {
                updateStatus('æ­£åœ¨è§£æå•†å“ä¿¡æ¯...', 'æå–å•†å“è¯¦æƒ…å’Œä»·æ ¼');
                const found = parseInt(document.getElementById('foundCount').textContent);
                document.getElementById('savedCount').textContent = Math.floor(found * 0.8);
            } else if (progress < 95) {
                updateStatus('æ­£åœ¨ä¿å­˜æ•°æ®...', 'å°†å•†å“ä¿¡æ¯ä¿å­˜åˆ°æ•°æ®åº“');
            }
        }, 800);

        // ä¿å­˜interval IDä»¥ä¾¿åç»­æ¸…ç†
        window.progressInterval = progressInterval;
    }

    // æ›´æ–°è¿›åº¦
    function updateProgress(progress) {
        document.getElementById('mainProgressBar').style.width = progress + '%';
        document.getElementById('progressPercentage').textContent = Math.round(progress) + '%';
    }

    // æ›´æ–°çŠ¶æ€
    function updateStatus(mainStatus, detailStatus) {
        document.getElementById('statusText').textContent = mainStatus;
        document.getElementById('detailText').textContent = detailStatus;
    }

    // å®Œæˆè¿›åº¦
    function completeProgress() {
        if (window.progressInterval) {
            clearInterval(window.progressInterval);
        }

        updateProgress(100);
        updateStatus('çˆ¬å–å®Œæˆ!', 'æ‰€æœ‰æ•°æ®å·²ä¿å­˜åˆ°æ•°æ®åº“');
        addLog('çˆ¬å–å®Œæˆ! æ­£åœ¨æ¸…ç†èµ„æº...', 'success');

        setTimeout(() => {
            document.getElementById('progressArea').style.display = 'none';
        }, 2000);
    }

    // è®¾ç½®çˆ¬å–çŠ¶æ€
    function setScrapingState(scraping) {
        isScraping = scraping;
        const scrapeBtn = document.getElementById('scrapeBtn');
        const statusSpinner = document.getElementById('statusSpinner');

        if (scraping) {
            scrapeBtn.disabled = true;
            scrapeBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> çˆ¬å–ä¸­...';
            statusSpinner.style.display = 'inline-block';
        } else {
            scrapeBtn.disabled = false;
            scrapeBtn.innerHTML = '<i class="bi bi-play-circle"></i> å¼€å§‹çˆ¬å–';
            statusSpinner.style.display = 'none';
        }
    }

    // æ·»åŠ æ—¥å¿—
    function addLog(message, type = 'info') {
        const logOutput = document.getElementById('logOutput');
        const timestamp = new Date().toLocaleTimeString();
        const typeIcons = {
            'info': 'â„¹ï¸',
            'success': 'âœ…',
            'error': 'âŒ',
            'warning': 'âš ï¸'
        };

        const logMessage = `[${timestamp}] ${typeIcons[type]} ${message}`;
        logMessages.push(logMessage);

        // ä¿æŒæœ€å¤š20æ¡æ—¥å¿—
        if (logMessages.length > 20) {
            logMessages.shift();
        }

        logOutput.innerHTML = logMessages.map(msg =>
            `<div class="log-line">${msg}</div>`
        ).join('');

        // æ»šåŠ¨åˆ°åº•éƒ¨
        logOutput.scrollTop = logOutput.scrollHeight;
    }

    // æ¸…ç©ºæ—¥å¿—
    function clearLogs() {
        logMessages = [];
        document.getElementById('logOutput').innerHTML = '<div class="text-muted">æ—¥å¿—å·²æ¸…ç©º</div>';
    }

    // æ˜¾ç¤ºç»“æœ
    function showResult(type, message) {
        const resultArea = document.getElementById('resultArea');
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const icon = type === 'success' ? 'bi-check-circle-fill' : 'bi-x-circle-fill';
        const title = type === 'success' ? 'ğŸ‰ çˆ¬å–æˆåŠŸï¼' : 'âš ï¸ çˆ¬å–å¤±è´¥ï¼';

        resultArea.innerHTML = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                <div class="d-flex align-items-start">
                    <i class="bi ${icon} fs-4 me-3"></i>
                    <div class="flex-grow-1">
                        <h6 class="alert-heading">${title}</h6>
                        <p class="mb-2">${message}</p>
                        ${type === 'success' ? `
                            <div class="d-flex gap-2">
                                <a href="/" class="btn btn-success btn-sm">
                                    <i class="bi bi-list"></i> æŸ¥çœ‹å•†å“
                                </a>
                                <a href="/stats" class="btn btn-outline-success btn-sm">
                                    <i class="bi bi-bar-chart"></i> æŸ¥çœ‹ç»Ÿè®¡
                                </a>
                                <button class="btn btn-outline-primary btn-sm" onclick="resetForm()">
                                    <i class="bi bi-arrow-clockwise"></i> ç»§ç»­çˆ¬å–
                                </button>
                            </div>
                        ` : ''}
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            </div>
        `;
        resultArea.style.display = 'block';

        // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
        resultArea.scrollIntoView({ behavior: 'smooth' });
    }

    // é‡ç½®è¡¨å•
    function resetForm() {
        document.getElementById('resultArea').style.display = 'none';
        document.getElementById('keyword').value = 'æ‰‹æœº';
        document.getElementById('max_pages').value = '3';
        document.getElementById('delay').value = '2';
    }

  
    // æ£€æŸ¥CookieçŠ¶æ€
    async function checkCookieStatus() {
        const cookieAlert = document.getElementById('cookieAlert');
        try {
            const response = await fetch('/api/check-cookie', {
                method: 'POST'
            });
            const result = await response.json();

            if (result.valid) {
                cookieAlert.className = 'alert alert-success border-0';
                cookieAlert.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="bi bi-check-circle-fill me-2"></i>
                        <div>
                            <strong>CookieçŠ¶æ€è‰¯å¥½</strong>
                            <div class="small">ç”¨æˆ·: ${result.info.username || 'æœªçŸ¥'} | æœ‰æ•ˆæœŸè‡³: ${result.info.expiry}</div>
                        </div>
                        <button class="btn btn-sm btn-outline-success ms-auto" onclick="checkCookieStatus()">
                            åˆ·æ–°çŠ¶æ€
                        </button>
                    </div>
                `;
            } else {
                cookieAlert.className = 'alert alert-danger border-0';
                cookieAlert.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="bi bi-x-circle-fill me-2"></i>
                        <div>
                            <strong>CookieçŠ¶æ€å¼‚å¸¸</strong>
                            <div class="small">${result.message}</div>
                        </div>
                        <a href="/system_settings" class="btn btn-sm btn-danger ms-auto">
                            æ›´æ–°Cookie
                        </a>
                    </div>
                `;
            }
        } catch (error) {
            cookieAlert.className = 'alert alert-warning border-0';
            cookieAlert.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <div>
                        <strong>æ— æ³•æ£€æŸ¥CookieçŠ¶æ€</strong>
                        <div class="small">${error.message}</div>
                    </div>
                    <button class="btn btn-sm btn-outline-warning ms-auto" onclick="checkCookieStatus()">
                        é‡è¯•
                    </button>
                </div>
            `;
        }
    }

    // æµ‹è¯•è¿æ¥
    async function testConnection() {
        showToast('æ­£åœ¨æµ‹è¯•è¿æ¥...', 'info');
        try {
            const response = await fetch('/api/stats');
            if (response.ok) {
                showToast('è¿æ¥æµ‹è¯•æˆåŠŸï¼', 'success');
            } else {
                showToast('è¿æ¥æµ‹è¯•å¤±è´¥', 'error');
            }
        } catch (error) {
            showToast('è¿æ¥æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
        }
    }

    // é¢„è§ˆå…³é”®è¯
    function previewKeyword() {
        const keyword = document.getElementById('keyword').value.trim();
        if (!keyword) {
            showToast('è¯·å…ˆè¾“å…¥å…³é”®è¯', 'warning');
            return;
        }

        // è¿™é‡Œå¯ä»¥è°ƒç”¨APIé¢„è§ˆæœç´¢ç»“æœæ•°é‡
        showToast(`å…³é”®è¯ "${keyword}" é¢„è§ˆåŠŸèƒ½å¼€å‘ä¸­...`, 'info');
    }

    // åŠ è½½ç³»ç»Ÿç»Ÿè®¡
    async function loadSystemStats() {
        try {
            const response = await fetch('/api/stats');
            const data = await response.json();

            // åˆå¹¶æ˜¾ç¤ºï¼šæ€»æ•° + ä»Šæ—¥æ–°å¢
            const totalText = data.total_products.toLocaleString();
            const todayNew = data.today_new || 0;
            const displayText = todayNew > 0 ? `${totalText} (ä»Šæ—¥+${todayNew})` : totalText;
            document.getElementById('productStats').textContent = displayText;
            document.getElementById('avgPrice').textContent = 'Â¥' + Math.round(data.price_stats.avg_price);
            document.getElementById('keywordCount').textContent = data.keyword_distribution.length;

            
        } catch (error) {
            console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
            document.getElementById('productStats').textContent = 'è·å–å¤±è´¥';
            document.getElementById('avgPrice').textContent = 'è·å–å¤±è´¥';
            document.getElementById('keywordCount').textContent = 'è·å–å¤±è´¥';
        }
    }

    // åˆ·æ–°ç»Ÿè®¡
    function refreshStats() {
        showToast('æ­£åœ¨åˆ·æ–°ç»Ÿè®¡æ•°æ®...', 'info');
        loadSystemStats();
        setTimeout(() => {
            showToast('ç»Ÿè®¡æ•°æ®å·²æ›´æ–°', 'success');
        }, 1000);
    }

    
    // ä¿å­˜å…³é”®è¯åˆ°å†å²
    function saveKeywordToHistory(keyword) {
        let history = JSON.parse(localStorage.getItem('keywordHistory') || '[]');
        history.unshift({
            keyword: keyword,
            timestamp: new Date().toISOString()
        });

        // ä¿ç•™æœ€è¿‘20ä¸ª
        history = history.slice(0, 20);

        localStorage.setItem('keywordHistory', JSON.stringify(history));
        loadKeywordHistory();
    }

    let currentKeywordHistory = [];

// åŠ è½½å…³é”®è¯å†å²
    function loadKeywordHistory() {
        const history = JSON.parse(localStorage.getItem('keywordHistory') || '[]');
        currentKeywordHistory = history;

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        updateHistoryStatistics();

        // æ¸²æŸ“å…³é”®è¯åˆ—è¡¨
        renderKeywordList(history);
    }

    // æ›´æ–°å†å²ç»Ÿè®¡ä¿¡æ¯
    function updateHistoryStatistics() {
        const history = currentKeywordHistory;
        document.getElementById('totalHistoryCount').textContent = history.length;
    }

    // æ¸²æŸ“å…³é”®è¯åˆ—è¡¨
    function renderKeywordList(history) {
        const historyList = document.getElementById('keywordHistoryList');

        if (history.length === 0) {
            historyList.innerHTML = `
                <div class="text-center py-4">
                    <i class="bi bi-inbox fs-1 text-muted"></i>
                    <p class="text-muted mt-2">æš‚æ— å†å²è®°å½•</p>
                    <small class="text-muted">ä½¿ç”¨æœç´¢åŠŸèƒ½åï¼Œå…³é”®è¯å°†è‡ªåŠ¨ä¿å­˜åˆ°è¿™é‡Œ</small>
                </div>
            `;
            return;
        }

        historyList.innerHTML = history.map((item, index) => {
            const date = new Date(item.timestamp);
            const timeStr = date.toLocaleString('zh-CN', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            return `
                <div class="keyword-item" data-keyword="${item.keyword}" data-index="${index}">
                    <div class="card border-0 bg-light mb-2">
                        <div class="card-body py-2">
                            <div class="row align-items-center">
                                <div class="col-8">
                                    <div class="fw-bold text-primary" style="cursor: pointer;"
                                         onclick="selectKeyword('${item.keyword}')">
                                        <i class="bi bi-search"></i> ${item.keyword}
                                    </div>
                                    <div class="small text-muted">
                                        <i class="bi bi-clock"></i> ${timeStr}
                                    </div>
                                </div>
                                <div class="col-4 text-end">
                                    <button class="btn btn-sm btn-outline-primary" onclick="selectKeyword('${item.keyword}')">
                                        <i class="bi bi-check-circle"></i> é€‰æ‹©
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="removeKeywordFromHistory(${index})">
                                        <i class="bi bi-trash"></i> åˆ é™¤
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    // é€‰æ‹©å…³é”®è¯
    function selectKeyword(keyword) {
        document.getElementById('keyword').value = keyword;
        showToast(`å·²é€‰æ‹©å…³é”®è¯: ${keyword}`, 'success');

        // ä¿å­˜å…³é”®è¯åˆ°å†å²ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        saveKeywordToHistory(keyword);

        // å…³é—­æ¨¡æ€æ¡†
        const modal = bootstrap.Modal.getInstance(document.getElementById('keywordHistoryModal'));
        modal.hide();
    }

    // åˆ‡æ¢å…³é”®è¯é€‰æ‹©çŠ¶æ€
    function toggleKeywordSelection(keyword, index) {
        const key = keyword + '_' + index;
        if (selectedKeywords.has(key)) {
            selectedKeywords.delete(key);
        } else {
            selectedKeywords.add(key);
        }
        updateBatchDeleteButton();
    }

    // æ›´æ–°æ‰¹é‡åˆ é™¤æŒ‰é’®çŠ¶æ€
    function updateBatchDeleteButton() {
        const batchDeleteBtn = document.getElementById('batchDeleteBtn');
        if (selectedKeywords.size > 0) {
            batchDeleteBtn.style.display = 'inline-block';
            batchDeleteBtn.innerHTML = `<i class="bi bi-trash"></i> åˆ é™¤é€‰ä¸­ (${selectedKeywords.size})`;
        } else {
            batchDeleteBtn.style.display = 'none';
        }
    }

    // å…¨é€‰/å–æ¶ˆå…¨é€‰
    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAllKeywords').checked;
        const checkboxes = document.querySelectorAll('.keyword-checkbox');

        selectedKeywords.clear();
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll;
            if (selectAll) {
                selectedKeywords.add(checkbox.value);
            }
        });

        updateBatchDeleteButton();
    }

    // åˆ é™¤é€‰ä¸­çš„å†å²è®°å½•
    function clearSelectedHistory() {
        if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedKeywords.size} æ¡è®°å½•å—ï¼Ÿ`)) {
            return;
        }

        let history = [...currentKeywordHistory];
        const toDelete = Array.from(selectedKeywords);

        toDelete.forEach(key => {
            const [keyword, index] = key.split('_');
            const idx = parseInt(index);
            if (history[idx] && history[idx].keyword === keyword) {
                history.splice(idx, 1);
            }
        });

        currentKeywordHistory = history;
        localStorage.setItem('keywordHistory', JSON.stringify(history));
        selectedKeywords.clear();

        loadKeywordHistory();
        showToast('é€‰ä¸­çš„å†å²è®°å½•å·²åˆ é™¤', 'success');
    }

    // åˆ é™¤å•ä¸ªå…³é”®è¯
    function removeKeywordFromHistory(index) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
            return;
        }

        const history = [...currentKeywordHistory];
        history.splice(index, 1);

        currentKeywordHistory = history;
        localStorage.setItem('keywordHistory', JSON.stringify(history));

        loadKeywordHistory();
        showToast('å†å²è®°å½•å·²åˆ é™¤', 'success');
    }

    // æ¸…ç©ºæ‰€æœ‰å†å²
    function clearAllHistory() {
        if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
            return;
        }

        currentKeywordHistory = [];
        selectedKeywords.clear();
        localStorage.removeItem('keywordHistory');

        loadKeywordHistory();
        showToast('æ‰€æœ‰å†å²è®°å½•å·²æ¸…ç©º', 'success');
    }

    
    
    
    // æ˜¾ç¤ºå…³é”®è¯å†å²
    function showKeywordHistory() {
        const modal = new bootstrap.Modal(document.getElementById('keywordHistoryModal'));
        modal.show();
    }

    // Toastæç¤º
    function showToast(message, type = 'info') {
        let toastContainer = document.getElementById('toastContainer');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toastContainer';
            toastContainer.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
            `;
            document.body.appendChild(toastContainer);
        }

        const alertClass = {
            'info': 'alert-info',
            'success': 'alert-success',
            'warning': 'alert-warning',
            'error': 'alert-danger'
        }[type] || 'alert-info';

        const toast = document.createElement('div');
        toast.className = `alert ${alertClass} alert-dismissible fade show`;
        toast.style.cssText = `
            min-width: 300px;
            margin-bottom: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        `;
        toast.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        toastContainer.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }
</script>
{% endblock %} 
 
