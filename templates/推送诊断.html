<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨é€è¯Šæ–­</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .diagnostic-section { background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .status { padding: 10px; border-radius: 5px; margin: 10px 0; }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; }
        .warning { background-color: #fff3cd; border: 1px solid #ffeaa7; }
        .info { background-color: #d1ecf1; border: 1px solid #bee5eb; }
        .btn { background-color: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block; margin: 5px; cursor: pointer; border: none; }
        .btn-success { background-color: #28a745; }
        .btn-warning { background-color: #ffc107; color: #212529; }
        .btn-danger { background-color: #dc3545; }
        pre { background-color: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
        .config-item { margin: 10px 0; padding: 10px; background-color: white; border-radius: 5px; }
        .product-item { margin: 10px 0; padding: 10px; background-color: white; border-radius: 5px; border-left: 4px solid #007bff; }
    </style>
</head>
<body>
    <h1>ğŸ” æ¨é€åŠŸèƒ½è¯Šæ–­</h1>

    <div class="diagnostic-section">
        <h3>ğŸ“Š ç³»ç»ŸçŠ¶æ€æ£€æŸ¥</h3>
        <button onclick="diagnoseSystem()" class="btn btn-success">å¼€å§‹è¯Šæ–­</button>
        <div id="systemDiagnosis"></div>
    </div>

    <div class="diagnostic-section">
        <h3>ğŸ“¢ é€šçŸ¥é…ç½®æ£€æŸ¥</h3>
        <button onclick="checkNotificationConfigs()" class="btn">æ£€æŸ¥é€šçŸ¥é…ç½®</button>
        <div id="notificationConfigs"></div>
    </div>

    <div class="diagnostic-section">
        <h3>ğŸ“¦ æœ€æ–°å•†å“æ£€æŸ¥</h3>
        <button onclick="checkLatestProducts()" class="btn">æ£€æŸ¥æœ€æ–°å•†å“</button>
        <div id="latestProducts"></div>
    </div>

    <div class="diagnostic-section">
        <h3>ğŸ§ª æ‰‹åŠ¨æ¨é€æµ‹è¯•</h3>
        <button onclick="testManualPush()" class="btn btn-warning">æµ‹è¯•æ‰‹åŠ¨æ¨é€</button>
        <div id="manualTestResult"></div>
    </div>

    <div class="diagnostic-section">
        <h3>ğŸ”§ é—®é¢˜è¯Šæ–­æŒ‡å—</h3>
        <div class="info">
            <h4>å¸¸è§é—®é¢˜ï¼š</h4>
            <ul>
                <li><strong>æ²¡æœ‰é€šçŸ¥é…ç½®</strong> - éœ€è¦å…ˆåˆ›å»ºå¹¶å¯ç”¨é€šçŸ¥é…ç½®</li>
                <li><strong>æœªå¯ç”¨æœ€æ–°å•†å“æ¨é€</strong> - åœ¨é€šçŸ¥é…ç½®ä¸­éœ€è¦å¯ç”¨"æœ€æ–°å‘å¸ƒå•†å“"é€‰é¡¹</li>
                <li><strong>Webhookåœ°å€æ— æ•ˆ</strong> - æ£€æŸ¥ä¼ä¸šå¾®ä¿¡/é’‰é’‰çš„webhookåœ°å€æ˜¯å¦æ­£ç¡®</li>
                <li><strong>æ²¡æœ‰æ–°å•†å“</strong> - ç³»ç»Ÿåªæ¨é€æ–°çˆ¬å–çš„å•†å“ï¼Œå·²æœ‰å•†å“ä¸ä¼šé‡å¤æ¨é€</li>
                <li><strong>ç½‘ç»œé—®é¢˜</strong> - æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œé˜²ç«å¢™è®¾ç½®</li>
            </ul>
        </div>
    </div>

    <div style="text-align: center; margin-top: 30px;">
        <a href="/" class="btn">è¿”å›é¦–é¡µ</a>
        <a href="/system-settings" class="btn">ç³»ç»Ÿè®¾ç½®</a>
        <a href="/test_notifications.html" class="btn">æµ‹è¯•é€šçŸ¥</a>
    </div>

    <script>
        // ç³»ç»Ÿè¯Šæ–­
        async function diagnoseSystem() {
            const resultDiv = document.getElementById('systemDiagnosis');
            resultDiv.innerHTML = '<p>æ­£åœ¨è¯Šæ–­ç³»ç»Ÿ...</p>';

            try {
                const response = await fetch('/api/quick-push-status');
                const data = await response.json();

                let html = '<h4>å¿«é€Ÿæ¨é€çŠ¶æ€ï¼š</h4>';
                if (data.enabled) {
                    html += '<div class="status success">âœ… å¿«é€Ÿæ¨é€å·²å¯ç”¨</div>';
                } else {
                    html += '<div class="status warning">âš ï¸ å¿«é€Ÿæ¨é€æœªå¯ç”¨ï¼ˆè¿™æ˜¯æ­£å¸¸çš„ï¼Œæ‚¨ä½¿ç”¨çš„æ˜¯é€šçŸ¥é…ç½®ä¸­çš„æ¨é€åŠŸèƒ½ï¼‰</div>';
                }

                html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">âŒ è¯Šæ–­å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ£€æŸ¥é€šçŸ¥é…ç½®
        async function checkNotificationConfigs() {
            const resultDiv = document.getElementById('notificationConfigs');
            resultDiv.innerHTML = '<p>æ­£åœ¨æ£€æŸ¥é€šçŸ¥é…ç½®...</p>';

            try {
                const response = await fetch('/api/notification-configs');
                const configs = await response.json();

                if (configs.length === 0) {
                    resultDiv.innerHTML = '<div class="status error">âŒ æ²¡æœ‰æ‰¾åˆ°é€šçŸ¥é…ç½®ï¼Œè¯·å…ˆæ·»åŠ é€šçŸ¥é…ç½®</div>';
                    return;
                }

                let html = `<h4>æ‰¾åˆ° ${configs.length} ä¸ªé€šçŸ¥é…ç½®ï¼š</h4>`;

                configs.forEach(config => {
                    const events = JSON.parse(config.events || '{}');
                    const hasLatestProduct = events.latest_product === true;
                    const isEnabled = config.enabled === true;

                    html += `
                        <div class="config-item">
                            <h5>${config.config_name}</h5>
                            <p><strong>çŠ¶æ€:</strong> ${isEnabled ? 'âœ… å·²å¯ç”¨' : 'âŒ å·²ç¦ç”¨'}</p>
                            <p><strong>ç±»å‹:</strong> ${config.webhook_type}</p>
                            <p><strong>æœ€æ–°å•†å“æ¨é€:</strong> ${hasLatestProduct ? 'âœ… å·²å¯ç”¨' : 'âŒ æœªå¯ç”¨'}</p>
                            <p><strong>Webhook:</strong> ${config.webhook_url ? 'âœ… å·²é…ç½®' : 'âŒ æœªé…ç½®'}</p>
                            <p><strong>æè¿°:</strong> ${config.description || 'æ— '}</p>
                        </div>
                    `;

                    if (!isEnabled) {
                        html += '<div class="status warning">âš ï¸ æ­¤é…ç½®å·²ç¦ç”¨ï¼Œéœ€è¦å¯ç”¨æ‰èƒ½æ¨é€</div>';
                    }
                    if (!hasLatestProduct) {
                        html += '<div class="status warning">âš ï¸ æ­¤é…ç½®æœªå¯ç”¨æœ€æ–°å•†å“æ¨é€</div>';
                    }
                    if (!config.webhook_url) {
                        html += '<div class="status error">âŒ æ­¤é…ç½®ç¼ºå°‘webhookåœ°å€</div>';
                    }
                });

                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">âŒ æ£€æŸ¥å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ£€æŸ¥æœ€æ–°å•†å“
        async function checkLatestProducts() {
            const resultDiv = document.getElementById('latestProducts');
            resultDiv.innerHTML = '<p>æ­£åœ¨æ£€æŸ¥æœ€æ–°å•†å“...</p>';

            try {
                // è¿™é‡Œéœ€è¦æ·»åŠ è·å–æœ€æ–°å•†å“çš„API
                // æš‚æ—¶æ˜¾ç¤ºæ¨¡æ‹Ÿç»“æœ
                resultDiv.innerHTML = `
                    <div class="status info">ğŸ“‹ è¯·é€šè¿‡é¦–é¡µæŸ¥çœ‹å•†å“åˆ—è¡¨</div>
                    <p><strong>æ£€æŸ¥è¦ç‚¹ï¼š</strong></p>
                    <ul>
                        <li>æ˜¯å¦æœ‰æ–°çˆ¬å–çš„å•†å“</li>
                        <li>å•†å“çš„æœç´¢æ—¶é—´æ˜¯å¦æ˜¯æœ€è¿‘çš„</li>
                        <li>å•†å“æ•°æ®æ˜¯å¦å®Œæ•´ï¼ˆæ ‡é¢˜ã€ä»·æ ¼ã€é“¾æ¥ç­‰ï¼‰</li>
                    </ul>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">âŒ æ£€æŸ¥å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ‰‹åŠ¨æ¨é€æµ‹è¯•
        async function testManualPush() {
            const resultDiv = document.getElementById('manualTestResult');
            resultDiv.innerHTML = '<p>æ­£åœ¨æµ‹è¯•æ¨é€...</p>';

            try {
                // å…ˆè·å–é€šçŸ¥é…ç½®
                const configsResponse = await fetch('/api/notification-configs');
                const configs = await configsResponse.json();

                if (configs.length === 0) {
                    resultDiv.innerHTML = '<div class="status error">âŒ æ²¡æœ‰æ‰¾åˆ°é€šçŸ¥é…ç½®</div>';
                    return;
                }

                // æ‰¾åˆ°å¯ç”¨äº†æœ€æ–°å•†å“æ¨é€çš„é…ç½®
                const validConfigs = configs.filter(config => {
                    const events = JSON.parse(config.events || '{}');
                    return config.enabled && events.latest_product && config.webhook_url;
                });

                if (validConfigs.length === 0) {
                    resultDiv.innerHTML = '<div class="status error">âŒ æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„é€šçŸ¥é…ç½®ï¼ˆå·²å¯ç”¨ + æœ€æ–°å•†å“æ¨é€ + webhookåœ°å€ï¼‰</div>';
                    return;
                }

                // ä½¿ç”¨ç¬¬ä¸€ä¸ªæœ‰æ•ˆé…ç½®è¿›è¡Œæµ‹è¯•
                const testResponse = await fetch('/api/test-latest-products', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ config_id: validConfigs[0].id })
                });

                const result = await testResponse.json();

                if (result.success) {
                    resultDiv.innerHTML = `<div class="status success">âœ… ${result.message}</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="status error">âŒ ${result.message}</div>`;
                }

            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œè¯Šæ–­
        window.addEventListener('load', function() {
            diagnoseSystem();
        });
    </script>
</body>
</html>