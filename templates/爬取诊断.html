<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çˆ¬å–è¯Šæ–­</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .diagnostic-section { background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .status { padding: 10px; border-radius: 5px; margin: 10px 0; }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; }
        .warning { background-color: #fff3cd; border: 1px solid #ffeaa7; }
        .info { background-color: #d1ecf1; border: 1px solid #bee5eb; }
        .btn { background-color: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block; margin: 5px; cursor: pointer; border: none; }
        .btn-success { background-color: #28a745; }
        .btn-warning { background-color: #ffc107; color: #212529; }
        .btn-danger { background-color: #dc3545; }
        pre { background-color: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
    </style>
</head>
<body>
    <h1>ğŸ” çˆ¬å–åŠŸèƒ½è¯Šæ–­</h1>

    <div class="diagnostic-section">
        <h3>ğŸ“Š ç³»ç»ŸçŠ¶æ€æ£€æŸ¥</h3>
        <button onclick="checkSystemStatus()" class="btn btn-success">æ£€æŸ¥ç³»ç»ŸçŠ¶æ€</button>
        <div id="systemStatus"></div>
    </div>

    <div class="diagnostic-section">
        <h3>ğŸª Cookieé…ç½®æ£€æŸ¥</h3>
        <button onclick="checkCookieConfig()" class="btn">æ£€æŸ¥Cookieé…ç½®</button>
        <div id="cookieConfig"></div>
    </div>

    <div class="diagnostic-section">
        <h3>ğŸ“¦ æ•°æ®åº“å•†å“æ£€æŸ¥</h3>
        <button onclick="checkDatabaseProducts()" class="btn">æ£€æŸ¥æ•°æ®åº“å•†å“</button>
        <div id="databaseProducts"></div>
    </div>

    <div class="diagnostic-section">
        <h3>ğŸ§ª çˆ¬å–åŠŸèƒ½æµ‹è¯•</h3>
        <form id="scrapeTestForm">
            <div class="form-group">
                <label for="testKeyword">æµ‹è¯•å…³é”®è¯ï¼š</label>
                <input type="text" id="testKeyword" value="èŠ±ç›†" placeholder="è¾“å…¥æµ‹è¯•å…³é”®è¯">
            </div>
            <div class="form-group">
                <label for="testPages">æµ‹è¯•é¡µæ•°ï¼š</label>
                <select id="testPages">
                    <option value="1">1é¡µ</option>
                    <option value="2">2é¡µ</option>
                    <option value="3" selected>3é¡µ</option>
                </select>
            </div>
            <div class="form-group">
                <label for="testDelay">å»¶è¿Ÿæ—¶é—´ï¼ˆç§’ï¼‰ï¼š</label>
                <select id="testDelay">
                    <option value="1">1ç§’</option>
                    <option value="2" selected>2ç§’</option>
                    <option value="3">3ç§’</option>
                    <option value="5">5ç§’</option>
                </select>
            </div>
            <button type="submit" class="btn btn-warning">å¼€å§‹æµ‹è¯•çˆ¬å–</button>
        </form>
        <div id="scrapeTestResult"></div>
    </div>

    <div class="diagnostic-section">
        <h3>ğŸ”§ é—®é¢˜è¯Šæ–­æŒ‡å—</h3>
        <div class="info">
            <h4>å¸¸è§çˆ¬å–é—®é¢˜ï¼š</h4>
            <ul>
                <li><strong>Cookieæ— æ•ˆ</strong> - éœ€è¦æ›´æ–°é—²é±¼Cookie</li>
                <li><strong>ç½‘ç»œé—®é¢˜</strong> - æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œé˜²ç«å¢™</li>
                <li><strong>æµè§ˆå™¨é—®é¢˜</strong> - Playwrightæµè§ˆå™¨å¯åŠ¨å¤±è´¥</li>
                <li><strong>å…³é”®è¯é—®é¢˜</strong> - å…³é”®è¯å¤ªå…·ä½“å¯èƒ½å¯¼è‡´æ— ç»“æœ</li>
                <li><strong>åçˆ¬æœºåˆ¶</strong> - é—²é±¼å¯èƒ½æ£€æµ‹åˆ°çˆ¬è™«è¡Œä¸º</li>
            </ul>
        </div>
    </div>

    <div style="text-align: center; margin-top: 30px;">
        <a href="/" class="btn">è¿”å›é¦–é¡µ</a>
        <a href="/scrape" class="btn">çˆ¬å–é¡µé¢</a>
        <a href="/system-settings" class="btn">ç³»ç»Ÿè®¾ç½®</a>
    </div>

    <script>
        // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        async function checkSystemStatus() {
            const resultDiv = document.getElementById('systemStatus');
            resultDiv.innerHTML = '<p>æ­£åœ¨æ£€æŸ¥ç³»ç»ŸçŠ¶æ€...</p>';

            try {
                const response = await fetch('/api/system-info');
                const data = await response.json();

                let html = '<h4>ç³»ç»ŸçŠ¶æ€ï¼š</h4>';
                if (data.error) {
                    html += `<div class="status error">âŒ ç³»ç»ŸçŠ¶æ€æ£€æŸ¥å¤±è´¥: ${data.error}</div>`;
                } else {
                    html += '<div class="status success">âœ… ç³»ç»Ÿè¿è¡Œæ­£å¸¸</div>';
                    html += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                }

                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">âŒ æ£€æŸ¥å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ£€æŸ¥Cookieé…ç½®
        async function checkCookieConfig() {
            const resultDiv = document.getElementById('cookieConfig');
            resultDiv.innerHTML = '<p>æ­£åœ¨æ£€æŸ¥Cookieé…ç½®...</p>';

            try {
                const response = await fetch('/api/system-info');
                const data = await response.json();

                // è¿™é‡Œåº”è¯¥æœ‰ä¸€ä¸ªä¸“é—¨çš„APIæ¥æ£€æŸ¥Cookie
                // æš‚æ—¶æ˜¾ç¤ºé€šç”¨ä¿¡æ¯
                resultDiv.innerHTML = `
                    <div class="status info">ğŸ“‹ è¯·åœ¨ç³»ç»Ÿè®¾ç½®é¡µé¢æ£€æŸ¥Cookieé…ç½®</div>
                    <p><strong>æ£€æŸ¥è¦ç‚¹ï¼š</strong></p>
                    <ul>
                        <li>Cookieæ˜¯å¦å·²é…ç½®</li>
                        <li>Cookieæ˜¯å¦æœ‰æ•ˆï¼ˆæœªè¿‡æœŸï¼‰</li>
                        <li>Cookieæ ¼å¼æ˜¯å¦æ­£ç¡®</li>
                    </ul>
                    <p><a href="/system-settings" target="_blank">å‰å¾€ç³»ç»Ÿè®¾ç½®é¡µé¢</a></p>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">âŒ æ£€æŸ¥å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ£€æŸ¥æ•°æ®åº“å•†å“
        async function checkDatabaseProducts() {
            const resultDiv = document.getElementById('databaseProducts');
            resultDiv.innerHTML = '<p>æ­£åœ¨æ£€æŸ¥æ•°æ®åº“å•†å“...</p>';

            try {
                const response = await fetch('/api/products?page=1&limit=10');
                const data = await response.json();

                if (data.products && data.products.length > 0) {
                    let html = `<h4>æ•°æ®åº“ä¸­æœ‰ ${data.total} ä¸ªå•†å“ï¼š</h4>`;
                    html += '<div style="max-height: 300px; overflow-y: auto;">';

                    data.products.forEach(product => {
                        html += `
                            <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 5px;">
                                <h5>${product.title}</h5>
                                <p><strong>ä»·æ ¼:</strong> ${product.price}</p>
                                <p><strong>åœ°åŒº:</strong> ${product.location}</p>
                                <p><strong>å…³é”®è¯:</strong> ${product.keyword}</p>
                                <p><strong>æœç´¢æ—¶é—´:</strong> ${product.search_time}</p>
                            </div>
                        `;
                    });

                    html += '</div>';
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<div class="status warning">âš ï¸ æ•°æ®åº“ä¸­æ²¡æœ‰å•†å“æ•°æ®</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">âŒ æ£€æŸ¥å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æµ‹è¯•çˆ¬å–åŠŸèƒ½
        async function testScrape(keyword, maxPages, delay) {
            const resultDiv = document.getElementById('scrapeTestResult');
            resultDiv.innerHTML = '<p>æ­£åœ¨æµ‹è¯•çˆ¬å–åŠŸèƒ½...</p>';

            try {
                const formData = new FormData();
                formData.append('keyword', keyword);
                formData.append('max_pages', maxPages);
                formData.append('delay', delay);

                const response = await fetch('/scrape', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="status success">âœ… ${result.message}</div>
                        <p>çˆ¬å–æˆåŠŸï¼è¯·æ£€æŸ¥å•†å“åˆ—è¡¨é¡µé¢æŸ¥çœ‹ç»“æœã€‚</p>
                        <p><a href="/" target="_blank">æŸ¥çœ‹å•†å“åˆ—è¡¨</a></p>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="status error">âŒ çˆ¬å–å¤±è´¥: ${result.message}</div>`;
                }

            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }

        // è¡¨å•æäº¤å¤„ç†
        document.getElementById('scrapeTestForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const keyword = document.getElementById('testKeyword').value;
            const maxPages = document.getElementById('testPages').value;
            const delay = document.getElementById('testDelay').value;

            if (!keyword.trim()) {
                alert('è¯·è¾“å…¥æµ‹è¯•å…³é”®è¯');
                return;
            }

            testScrape(keyword, maxPages, delay);
        });

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        window.addEventListener('load', function() {
            checkSystemStatus();
        });
    </script>
</body>
</html>